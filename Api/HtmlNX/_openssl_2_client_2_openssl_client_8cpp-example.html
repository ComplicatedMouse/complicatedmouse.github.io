<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Openssl/Client/OpensslClient.cpp | NintendoSDK API Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="openclose.js"></script>
<script type="text/javascript" src="searchapi.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NintendoSDK API Reference
   &#160;<span id="projectnumber">14.1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Openssl/Client/OpensslClient.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>For an explanation of the source code, see <a class="el" href="_page_sample_open_ssl_client.html">HTTPS communication using OpenSSL library</a> and <tt>Openssl/Client/OpensslClient.cpp</tt>.</p>
<div class="fragment"><div class="line"><span class="comment">/*--------------------------------------------------------------------------------*</span></div>
<div class="line"><span class="comment">  Copyright Nintendo.  All rights reserved.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">  These coded instructions, statements, and computer programs contain proprietary</span></div>
<div class="line"><span class="comment">  information of Nintendo and/or its licensed developers and are protected by</span></div>
<div class="line"><span class="comment">  national and international copyright laws. They may not be disclosed to third</span></div>
<div class="line"><span class="comment">  parties or copied or duplicated in any form, in whole or in part, without the</span></div>
<div class="line"><span class="comment">  prior written consent of Nintendo.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">  The content herein is highly confidential and should be handled accordingly.</span></div>
<div class="line"><span class="comment"> *--------------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// ------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// Build flags.</span></div>
<div class="line"><span class="comment">// ------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// #define PRINT_SERVER_CERT // Enable this to print the obtained server certificate.</span></div>
<div class="line"><span class="comment">// #define PRINT_POSSIBLE_CIPHER_NAMES // Enable this to print possible selected ciphers to use for the OpenSSL connection.</span></div>
<div class="line"><span class="comment">// #define DISABLE_SESSION_CACHE // Enable this to disable session cache. This cannot be combined with SESSION_CACHE_TICKET.</span></div>
<div class="line"><span class="comment">// #define SESSION_CACHE_TICKET // Enable this to use session cache tickets. This cannot be combined with DISABLE_SESSION_CACHE.</span></div>
<div class="line"><span class="comment">// #define FLUSH_SESSION_CACHE // Enable this to flush session cache before destroying the connection.</span></div>
<div class="line"><span class="comment">// #define PRINT_FULL_PROCESS_BUFFER // Enable this to print the full website text.</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;new&gt;</span>               <span class="comment">// std::nothrow</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;nn/nn_SignedSize.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="nn___log_8h.html">nn/nn_Log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="nn___assert_8h.html">nn/nn_Assert.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="socket_8h.html">nn/socket.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;nn/nifm.h&gt;</span>         <span class="comment">// Network interface.</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fs_8h.html">nn/fs.h</a>&gt;</span>           <span class="comment">// File system.</span></div>
<div class="line"><span class="preprocessor">#include &lt;openssl/nnsdk.h&gt;</span>   <span class="comment">// ossl_nnsdk_config, SSL_library_nnsdk_init</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;openssl/x509v3.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;openssl/ssl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;openssl/err.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if defined(DISABLE_SESSION_CACHE) &amp;&amp; defined(SESSION_CACHE_TICKET)</span></div>
<div class="line"><span class="preprocessor">#error  &quot;Error: DISABLE_SESSION_CACHE and SESSION_CACHE_TICKET are incompatible. Please only define one of them.&quot;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace</span></div>
<div class="line">{</div>
<div class="line"><span class="comment">// ------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// Globals</span></div>
<div class="line"><span class="comment">// ------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// Network socket library static memory</span></div>
<div class="line"><a name="_a0"></a><a class="code" href="classnn_1_1socket_1_1_config_default_with_memory.html">nn::socket::ConfigDefaultWithMemory</a> g_SocketConfigWithMemory;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Buffer to store website GET request data</span></div>
<div class="line"><span class="keywordtype">char</span> g_ProcessBuffer[1024 * 256 * 4];</div>
<div class="line"><span class="keywordtype">size_t</span> g_ProcessBufferIndex = 0;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Command line argument information</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> CmdInputBufferSize = 256;</div>
<div class="line"><span class="keywordtype">char</span> g_HostName[CmdInputBufferSize] = {};</div>
<div class="line"><span class="keywordtype">char</span> g_CertificateFileDirectory[CmdInputBufferSize] = {};</div>
<div class="line"><span class="keywordtype">char</span> g_CertificateFileName[CmdInputBufferSize] = {};</div>
<div class="line"><span class="keywordtype">bool</span> g_IsCertificateValidationEnabled = <span class="keyword">false</span>;</div>
<div class="line"><span class="keywordtype">bool</span> g_IsCertFileInRom = <span class="keyword">false</span>;</div>
<div class="line"><span class="keywordtype">bool</span> g_IsCertFileInHost = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Initialization state</span></div>
<div class="line"><span class="keywordtype">bool</span> g_IsNifmLibInitialized = <span class="keyword">false</span>;</div>
<div class="line"><span class="keywordtype">bool</span> g_IsSocketLibInitialized = <span class="keyword">false</span>;</div>
<div class="line"><span class="keywordtype">bool</span> g_IsSslLibInitialized = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// The length of time to sleep between nonblocking SSL calls.</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> uint32_t SleepDurationMs = 5;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// Misc. helpers</span></div>
<div class="line"><span class="comment">// ------------------------------------------------------------------------------------------------</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// PrintOpenSslErrors empties the error stack within OpenSSL</span></div>
<div class="line"><span class="comment">// as it prints out each error.</span></div>
<div class="line"><span class="keywordtype">void</span> PrintOpenSslErrors(<span class="keyword">const</span> <span class="keywordtype">char</span>* pErrorOrigin, <span class="keywordtype">int</span> code) <a name="a1"></a><a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* errorName = <span class="keyword">nullptr</span>;</div>
<div class="line">    <span class="keywordflow">switch</span> (code)</div>
<div class="line">    {</div>
<div class="line">    <span class="keywordflow">case</span> SSL_ERROR_SSL:              errorName = <span class="stringliteral">&quot;SSL_ERROR_SSL&quot;</span>; <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> SSL_ERROR_SYSCALL:          errorName = <span class="stringliteral">&quot;SSL_ERROR_SYSCALL&quot;</span>; <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> SSL_ERROR_WANT_ASYNC_JOB:   errorName = <span class="stringliteral">&quot;SSL_ERROR_WANT_ASYNC_JOB&quot;</span>; <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> SSL_ERROR_WANT_ASYNC:       errorName = <span class="stringliteral">&quot;SSL_ERROR_WANT_ASYNC&quot;</span>; <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> SSL_ERROR_WANT_X509_LOOKUP: errorName = <span class="stringliteral">&quot;SSL_ERROR_WANT_X509_LOOKUP&quot;</span>; <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> SSL_ERROR_WANT_ACCEPT:      errorName = <span class="stringliteral">&quot;SSL_ERROR_WANT_ACCEPT&quot;</span>; <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> SSL_ERROR_WANT_CONNECT:     errorName = <span class="stringliteral">&quot;SSL_ERROR_WANT_CONNECT&quot;</span>; <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> SSL_ERROR_WANT_WRITE:       errorName = <span class="stringliteral">&quot;SSL_ERROR_WANT_WRITE&quot;</span>; <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> SSL_ERROR_WANT_READ:        errorName = <span class="stringliteral">&quot;SSL_ERROR_WANT_READ&quot;</span>; <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> SSL_ERROR_ZERO_RETURN:      errorName = <span class="stringliteral">&quot;SSL_ERROR_ZERO_RETURN&quot;</span>; <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> SSL_ERROR_NONE:             errorName = <span class="stringliteral">&quot;SSL_ERROR_NONE&quot;</span>; <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:                         errorName = <span class="stringliteral">&quot;Unexpected SSL Error&quot;</span>; <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <a name="a2"></a><a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;%s error code: %d, error name: %s.\n&quot;</span>, pErrorOrigin, code, errorName);</div>
<div class="line">    <span class="keywordflow">if</span> (errno != 0)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;errno: %d\n&quot;</span>, errno);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (ERR_peek_error() != 0)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;OpenSSL error stack:\n&quot;</span>);</div>
<div class="line">        <span class="comment">// peek error stack</span></div>
<div class="line">        <span class="keywordflow">while</span> (ERR_peek_error() != 0)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">int</span> line, flags;</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">char</span>* pFileName;</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">char</span>* pErrorDataString;</div>
<div class="line">            <span class="comment">// pop error stack</span></div>
<div class="line">            <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> errorCode = ERR_get_error_line_data(&amp;pFileName, &amp;line, &amp;pErrorDataString, &amp;flags);</div>
<div class="line">            <span class="comment">// set error string, pErrorStr points to static buffer</span></div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">char</span>* pErrorMsg = ERR_error_string(errorCode, <span class="keyword">nullptr</span>);</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Error message: %s, code: %lu, data: %s, flags: %d, in file %s at line %d.\n&quot;</span>,</div>
<div class="line">                pErrorMsg, errorCode, pErrorDataString, flags, pFileName, line);</div>
<div class="line">        }</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">void</span> PrintSocketError(<span class="keywordtype">int</span> socketFd) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> soError = 0;</div>
<div class="line">    <a class="code" href="namespacenn_1_1socket.html#a0da164bafc83a64e6a51068805e5df52">nn::socket::SockLenT</a> len = <span class="keyword">sizeof</span>(soError);</div>
<div class="line">    <span class="keywordtype">int</span> rval = <a name="a3"></a><a class="code" href="namespacenn_1_1socket.html#a4aff7a563a6c808b236246a182996761">nn::socket::GetSockOpt</a>(socketFd, <a name="a4"></a><a class="code" href="namespacenn_1_1socket.html#a8f9b7859b60d1ee546e472a7e2a9beaaa4418133767fb2aecc740f56abdda0a07">nn::socket::Level::Sol_Socket</a>,</div>
<div class="line">        <a name="a5"></a><a class="code" href="namespacenn_1_1socket.html#a9706518d71ec37371e9aa3ae9a2fa92caa09b2054c97d538ca128022bdb5d70ff">nn::socket::Option::So_Error</a>, &amp;soError, &amp;len);</div>
<div class="line">    <span class="keywordflow">if</span> (rval == -1)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;nn::socket::GetSockOpt(%d, nn::socket::Level::Sol_Socket,&quot;</span></div>
<div class="line">               <span class="stringliteral">&quot;nn::socket::Option::So_Error) failed.\n&quot;</span>, socketFd);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (soError != 0)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;TCP Socket encounter an error %d\n&quot;</span>, soError);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a6"></a><a class="code" href="namespacenn_1_1socket.html#a6db6951cb084f74f4c17d655ce798890">nn::socket::GetLastError</a>() != <a name="a7"></a><a class="code" href="namespacenn_1_1socket.html#ad1ade4838b158c7aaf9c9a78338e06aead87a63798e8be82fcb6b21bf1389ebb3">nn::socket::Errno::ESuccess</a>)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;nn::socket::GetLastError: %d\n&quot;</span>, <a class="code" href="namespacenn_1_1socket.html#a6db6951cb084f74f4c17d655ce798890">nn::socket::GetLastError</a>());</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">void</span> PrintNnResult(<span class="keyword">const</span> <span class="keywordtype">char</span>* pMsg, <a name="_a8"></a><a class="code" href="classnn_1_1_result.html">nn::Result</a> res) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;%s (%d-%d).\n&quot;</span>, pMsg, res.GetModule(), res.GetDescription());</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">void</span> PrintProcessBuffer() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <a name="a9"></a><a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(g_ProcessBufferIndex &lt; <span class="keyword">sizeof</span>(g_ProcessBuffer));</div>
<div class="line"><span class="preprocessor">#ifndef PRINT_FULL_PROCESS_BUFFER</span></div>
<div class="line">    <span class="comment">// Only print first line</span></div>
<div class="line">    <span class="keywordtype">char</span>* newline = strstr(g_ProcessBuffer, <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(newline != <span class="keyword">nullptr</span>)</div>
<div class="line">    {</div>
<div class="line">        *newline = 0;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;%s\n&quot;</span>, g_ProcessBuffer);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;+------------------------------------------+\n&quot;</span>);</div>
<div class="line">    <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;%s&quot;</span>, g_ProcessBuffer);</div>
<div class="line">    <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;\n+--- Processed a total of %7d bytes ---+\n&quot;</span>, g_ProcessBufferIndex);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">@brief  Class HttpsClient: the class to perform HTTP GET requests over OpenSSL</span></div>
<div class="line"><span class="comment">*  ----------------------------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keyword">struct </span>HttpsClient</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Code used to simplify or clarify the meaning of what is happening in OpenSSL.</span></div>
<div class="line">    <span class="keyword">enum</span> Code</div>
<div class="line">    {</div>
<div class="line">        Code_Error = -1,            <span class="comment">// Some error occurred that we did not expect.</span></div>
<div class="line">        Code_StreamTerminated = -2, <span class="comment">// Stream did not complete, Stopped from other side.</span></div>
<div class="line"> </div>
<div class="line">        Code_Processing = 0,        <span class="comment">// Stream would block, call function again later.</span></div>
<div class="line">        Code_OperationCompleted = 1,<span class="comment">// Operation completed.</span></div>
<div class="line">    };</div>
<div class="line">    <span class="comment">// Functions that return Status might need to be called multiple times when the isNonBlocking setting is true.</span></div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a></div>
<div class="line">    {</div>
<div class="line">        Code code;</div>
<div class="line">        <span class="keyword">union</span></div>
<div class="line">        {</div>
<div class="line">            nn::SignedSize bytesSent;</div>
<div class="line">            nn::SignedSize totalBytesReceived;</div>
<div class="line">        };</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Callback functions</span></div>
<div class="line">    <span class="keyword">typedef</span> <span class="keywordtype">char</span>* (*ProcessReceiveCallback)(<span class="keywordtype">char</span>* pData, <span class="keywordtype">size_t</span> len, <span class="keywordtype">void</span>* pUserData);</div>
<div class="line">    <span class="keyword">typedef</span> void (*EndOperationCallback)(HttpsClient* pHttpsClient, Code endCode, <span class="keywordtype">void</span>* pUserData);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">    <span class="comment">// Interface to OpenSSL Functions</span></div>
<div class="line">    <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">    <span class="keyword">explicit</span> HttpsClient(SSL_CTX* pImportCtx);</div>
<div class="line">    ~HttpsClient();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Establish an openSSL connection to hostIP; pHostName is passed for name certificate name validation.</span></div>
<div class="line">    <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a> EstablishConnection(<a name="_a10"></a><a class="code" href="structnn_1_1socket_1_1_in_addr.html">nn::socket::InAddr</a> hostIp, uint16_t portNum, <span class="keywordtype">bool</span> isNonBlocking, <span class="keyword">const</span> <span class="keywordtype">char</span>* pHostName) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a>;</div>
<div class="line">    <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a> <a class="code" href="namespacenn_1_1socket.html#a27f36d8472582558c3cb4a31464f50a0">Send</a>(<span class="keywordtype">char</span>* pSendBuffer, <span class="keywordtype">size_t</span> sendBufferSize, EndOperationCallback pEndFunc, <span class="keywordtype">void</span>* pEndFuncUserData) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a>;</div>
<div class="line">    <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a> Receive(<span class="keywordtype">char</span>* pReceiveBuffer, <span class="keywordtype">size_t</span> receiveBufferSize, ProcessReceiveCallback pProcessFunc, EndOperationCallback pEndFunc, <span class="keywordtype">void</span>* pProcessFuncUserData, <span class="keywordtype">void</span>* pEndFuncUserData) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Finalizes the HttpsClient.</span></div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespacenn_1_1htc.html#a8337c461b81d43d85571e7fa4e574c48">Finalize</a>() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// You may change the Socket&#39;s blocking/non-blocking state only after initialization has been completed</span></div>
<div class="line">    <span class="comment">// and no other thread is currently calling Send or Receive.</span></div>
<div class="line">    <span class="keywordtype">bool</span> SetSocketNonBlocking(<span class="keywordtype">bool</span> isNonBlocking) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// HttpsClient does not own the OpenSSL context because it may be reused between multiple https</span></div>
<div class="line">    <span class="comment">// requests. The OpenSSL context holds the certificate data, which is costly to read and decode.</span></div>
<div class="line">    <span class="keyword">static</span> SSL_CTX* CreateSslContext() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">    <span class="comment">// Static Data</span></div>
<div class="line">    <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> uint32_t HostNameBufLen = CmdInputBufferSize;            </div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">    <span class="comment">// Setup Helpers</span></div>
<div class="line">    <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">    <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a> SetupTcpSocket() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> SetupSslConnection() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a> PerformSslHandshake() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a>;</div>
<div class="line">    <span class="keywordtype">bool</span> VerifyCertificate() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">    <span class="comment">// Error Handling Helpers</span></div>
<div class="line">    <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">bool</span> IsBlockingCode(<span class="keywordtype">int</span> sslCode) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a>;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">bool</span> IsTerminatedCode(<span class="keywordtype">int</span> sslCode) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a>;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">bool</span> IsErrorCode(<span class="keywordtype">int</span> sslCode) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">    <span class="comment">// Internal Data</span></div>
<div class="line">    <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Initialization stages of the HttpsClient. Not every stage is blocking.</span></div>
<div class="line">    <span class="comment">// By calling EstablishConnection(...) all of the following steps will be completed.</span></div>
<div class="line">    <span class="keyword">enum</span> ConnectionStage</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Order of initialization: start</span></div>
<div class="line">        ConnectionStage_Start,</div>
<div class="line">        ConnectionStage_Initialize = ConnectionStage_Start,</div>
<div class="line">        ConnectionStage_TCPSocketCreate,              </div>
<div class="line">        ConnectionStage_TCPSocketStartConnect,</div>
<div class="line">        ConnectionStage_TCPSocketFinishConnect,</div>
<div class="line">        ConnectionStage_TCPSocketFinish,</div>
<div class="line"> </div>
<div class="line">        ConnectionStage_SSLConnectionSetup,           </div>
<div class="line"> </div>
<div class="line">        ConnectionStage_SSLConnectionHandshake,</div>
<div class="line">        ConnectionStage_EstablishConnectionFinish,</div>
<div class="line">        ConnectionStage_ConnectionReady,</div>
<div class="line">        <span class="comment">// Order of initialization: end</span></div>
<div class="line">    };</div>
<div class="line">    <span class="keyword">friend</span> <span class="keyword">inline</span> ConnectionStage&amp; operator++(ConnectionStage&amp; stage, <span class="keywordtype">int</span>) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span>                m_TcpSocket;                  </div>
<div class="line">    nn::SignedSize     m_ReceivedTotalBytes;         </div>
<div class="line">    nn::SignedSize     m_BytesSentFromBuffer;        </div>
<div class="line">    SSL_CTX*           m_pSslContext;                </div>
<div class="line">    SSL*               m_pSslConnection;             </div>
<div class="line">    <a class="code" href="structnn_1_1socket_1_1_in_addr.html">nn::socket::InAddr</a> m_HostIp;                     </div>
<div class="line">    uint16_t           m_PortNumber;                 </div>
<div class="line">    <span class="keywordtype">bool</span>               m_IsImportedSslContext;       </div>
<div class="line">    <span class="keywordtype">bool</span>               m_IsNonBlocking;              </div>
<div class="line">    ConnectionStage    m_ConnectionStage;            </div>
<div class="line">    <span class="keywordtype">char</span>               m_HostName[HostNameBufLen];   </div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">HttpsClient::ConnectionStage&amp; operator++(HttpsClient::ConnectionStage&amp; stage, <span class="keywordtype">int</span>) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    stage = <span class="keyword">static_cast&lt;</span>HttpsClient::ConnectionStage<span class="keyword">&gt;</span>(<span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(stage) + 1);</div>
<div class="line">    <a name="a11"></a><a class="code" href="nn___abort_8h.html#a5c1a90d3a6474658ae0ac5dc5bcb14e4">NN_ABORT_UNLESS</a>(stage &gt; HttpsClient::ConnectionStage::ConnectionStage_Start &amp;&amp;</div>
<div class="line">        stage &lt;= HttpsClient::ConnectionStage::ConnectionStage_ConnectionReady,</div>
<div class="line">        <span class="stringliteral">&quot;Fatal Error: Init stages is in a invalid state!&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> stage;</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">bool</span> HttpsClient::IsBlockingCode(<span class="keywordtype">int</span> sslCode) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Non-blocking SSL will automatically do renegotiation and return</span></div>
<div class="line">    <span class="comment">// WRITE + READ depending on its needs. READ and WRITE are similar to</span></div>
<div class="line">    <span class="comment">// EINPROGRESS for TCP.</span></div>
<div class="line">    <span class="keywordflow">return</span> sslCode == SSL_ERROR_WANT_WRITE || sslCode == SSL_ERROR_WANT_READ;</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">bool</span> HttpsClient::IsTerminatedCode(<span class="keywordtype">int</span> sslCode) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Stream was terminated by the host for some reason.</span></div>
<div class="line">    <span class="keywordflow">return</span> ( (sslCode == SSL_ERROR_SYSCALL &amp;&amp; <a class="code" href="namespacenn_1_1socket.html#a6db6951cb084f74f4c17d655ce798890">nn::socket::GetLastError</a>() == <a class="code" href="namespacenn_1_1socket.html#ad1ade4838b158c7aaf9c9a78338e06aead87a63798e8be82fcb6b21bf1389ebb3">nn::socket::Errno::ESuccess</a>) ||</div>
<div class="line">              sslCode == SSL_ERROR_ZERO_RETURN );</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">bool</span> HttpsClient::IsErrorCode(<span class="keywordtype">int</span> sslCode) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Encountered an error.</span></div>
<div class="line">    <span class="keywordflow">return</span> ( (sslCode == SSL_ERROR_SYSCALL &amp;&amp; <a class="code" href="namespacenn_1_1socket.html#a6db6951cb084f74f4c17d655ce798890">nn::socket::GetLastError</a>() != <a class="code" href="namespacenn_1_1socket.html#ad1ade4838b158c7aaf9c9a78338e06aead87a63798e8be82fcb6b21bf1389ebb3">nn::socket::Errno::ESuccess</a>) ||</div>
<div class="line">              sslCode == SSL_ERROR_SSL );</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">@brief  Initializes HttpsClient to be ready to connect to a given hostname.</span></div>
<div class="line"><span class="comment">                      If not given an OpenSSL context to import, it will create its own.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@param[in] pImportCtx  If nullptr, will be ignored. Otherwise, HttpsClient will use</span></div>
<div class="line"><span class="comment">                      the provided context for its connection and will NOT clean it up.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@details</span></div>
<div class="line"><span class="comment">HttpsClient Constructor</span></div>
<div class="line"><span class="comment">  1. Initialize states</span></div>
<div class="line"><span class="comment">  2. Initialize OpenSSL context or an already made one</span></div>
<div class="line"><span class="comment">*  ----------------------------------------------------------------------------------------------*/</span></div>
<div class="line">HttpsClient::HttpsClient(SSL_CTX* pImportCtx) :</div>
<div class="line">    m_TcpSocket(-1),</div>
<div class="line">    m_ReceivedTotalBytes(0),</div>
<div class="line">    m_BytesSentFromBuffer(0),</div>
<div class="line">    m_pSslContext(pImportCtx),</div>
<div class="line">    m_pSslConnection(<span class="keyword">nullptr</span>),</div>
<div class="line">    m_HostIp({ 0 }),</div>
<div class="line">    m_PortNumber(<span class="keyword">static_cast&lt;</span>uint16_t<span class="keyword">&gt;</span>(-1)),</div>
<div class="line">    m_IsImportedSslContext(<span class="keyword">false</span>),</div>
<div class="line">    m_IsNonBlocking(<span class="keyword">false</span>),</div>
<div class="line">    m_ConnectionStage(ConnectionStage::ConnectionStage_Start)</div>
<div class="line">{</div>
<div class="line">    m_HostName[0] = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Not importing a context?</span></div>
<div class="line">    <span class="keywordflow">if</span> (pImportCtx == <span class="keyword">nullptr</span>)</div>
<div class="line">    {</div>
<div class="line">        m_pSslContext = CreateSslContext();</div>
<div class="line">        <span class="comment">// Failed to setup SslContext</span></div>
<div class="line">        <span class="keywordflow">if</span> (m_pSslContext == <span class="keyword">nullptr</span>)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Failed to setup SSL context. This probably means the OpenSSL library has not been &quot;</span></div>
<div class="line">                   <span class="stringliteral">&quot;initialized. Or a selected certificate file was not properly accessed/loaded.\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        m_IsImportedSslContext = <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">@brief  Setup OpenSSL context so that it may be used by a connection. This includes version info,</span></div>
<div class="line"><span class="comment">           options, and certificate loading.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@return  Returns nullptr on error. If it succeeds it will return a pointer to the context.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@details</span></div>
<div class="line"><span class="comment">Setup SSL context.</span></div>
<div class="line"><span class="comment">  1. Create OpenSSL context by SSL_CTX_new(...)</span></div>
<div class="line"><span class="comment">  2. Configure OpenSSL context: options, sessionId, cache mode</span></div>
<div class="line"><span class="comment">  3. Load/Import CA certificate to context</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">Note that imported entities, like CA certificates and client PKI information, are volatile. These</span></div>
<div class="line"><span class="comment">entities are copied into the SSL library and maintained until the SSL context is destroyed.</span></div>
<div class="line"><span class="comment">*  ----------------------------------------------------------------------------------------------*/</span></div>
<div class="line">SSL_CTX* HttpsClient::CreateSslContext() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> optionFlags = SSL_OP_NO_SSLv2 | SSL_OP_NO_SSLv3 | SSL_OP_NO_COMPRESSION;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Create context using latest client TLS</span></div>
<div class="line">    SSL_CTX* pCtx = SSL_CTX_new(TLS_client_method());</div>
<div class="line">    <span class="keywordflow">if</span> (pCtx == <span class="keyword">nullptr</span>)</div>
<div class="line">    {</div>
<div class="line">        ERR_print_errors_fp(stderr);</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Failed to create an OpenSSL context.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> pCtx;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;OpenSSL context created.\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if !defined(SESSION_CACHE_TICKET)</span></div>
<div class="line">    optionFlags |= SSL_OP_NO_TICKET;</div>
<div class="line">    <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;OpenSSL context session cache ticket mode disabled.\n&quot;</span>);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;OpenSSL context session cache ticket mode enabled.\n&quot;</span>);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Set context flags</span></div>
<div class="line">    SSL_CTX_set_options(pCtx, optionFlags);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Configure Cache Session Mode</span></div>
<div class="line"><span class="preprocessor">#if defined(DISABLE_SESSION_CACHE)</span></div>
<div class="line">        SSL_CTX_set_session_cache_mode(pCtx, SSL_CTX_get_session_cache_mode(pCtx) | SSL_SESS_CACHE_OFF);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    <span class="comment">// Get/Print Cache Mode. Default mode is: SSL_SESS_CACHE_SERVER</span></div>
<div class="line">    <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;OpenSSL context session cache mode: %u.\n&quot;</span>, SSL_CTX_get_session_cache_mode(pCtx));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Get file system prefix</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* pFileSystemPrefix = <span class="keyword">nullptr</span>;</div>
<div class="line">    <span class="keywordflow">if</span> (g_IsCertFileInHost)</div>
<div class="line">    {</div>
<div class="line">        pFileSystemPrefix = <span class="stringliteral">&quot;host&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (g_IsCertFileInRom)</div>
<div class="line">    {</div>
<div class="line">        pFileSystemPrefix = <span class="stringliteral">&quot;rom&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="comment">// Do not load a certificate file</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> pCtx;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">char</span>* pRomCacheBuffer = <span class="keyword">nullptr</span>;</div>
<div class="line">    <span class="keywordtype">bool</span> isFileSystemMounted = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordtype">bool</span> isCertificateLoadSuccessful = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Mount file system</span></div>
<div class="line">        <a class="code" href="classnn_1_1_result.html">nn::Result</a> mountResult;</div>
<div class="line">        <span class="keywordflow">if</span> (g_IsCertFileInHost)</div>
<div class="line">        {</div>
<div class="line">            mountResult = <a name="a12"></a><a class="code" href="namespacenn_1_1fs.html#a1b85bf3f3cf038cb67a991a3e3304751">nn::fs::MountHost</a>(pFileSystemPrefix, g_CertificateFileDirectory);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (g_IsCertFileInRom)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Get minimum file cache size</span></div>
<div class="line">            <span class="keywordtype">size_t</span> romCacheSize = 0;</div>
<div class="line">            <a name="a13"></a><a class="code" href="namespacenn_1_1fs.html#a5df6e3385c795a5bd046790ef7f17f2d">nn::fs::QueryMountRomCacheSize</a>(&amp;romCacheSize);</div>
<div class="line">            <span class="comment">// Many certificate files are ~100kb so having a large cache will speed things up.</span></div>
<div class="line">            romCacheSize = (512 * romCacheSize &gt; 512 * 128) ?</div>
<div class="line">                (512 * 128) :  <span class="comment">// max 64kb</span></div>
<div class="line">                (512 * romCacheSize);</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// Allocate rom cache buffer</span></div>
<div class="line">            pRomCacheBuffer = <span class="keyword">new</span>(std::nothrow) <span class="keywordtype">char</span>[romCacheSize];</div>
<div class="line">            <span class="keywordflow">if</span> (pRomCacheBuffer == <span class="keyword">nullptr</span>)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            mountResult = <a name="a14"></a><a class="code" href="namespacenn_1_1fs.html#a2e453fe1fbf8f818dc45bbd2897105cd">nn::fs::MountRom</a>(pFileSystemPrefix, pRomCacheBuffer, romCacheSize);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Mount failed?</span></div>
<div class="line">        <span class="keywordflow">if</span> (mountResult.<a name="a15"></a><a class="code" href="classnn_1_1_result.html#a5d119d9cb4918fc3cd09215437b91c13">IsFailure</a>())</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;nn::fs::MountHost failed to mount %s path \&quot;%s%s\&quot; (%d-%d).\n&quot;</span>,</div>
<div class="line">                pFileSystemPrefix, g_CertificateFileDirectory, g_CertificateFileName,</div>
<div class="line">                mountResult.<a name="a16"></a><a class="code" href="classnn_1_1_result.html#a77240fc1cc27829bc388d34c97357693">GetModule</a>(), mountResult.<a name="a17"></a><a class="code" href="classnn_1_1_result.html#a800c5bb9b58c3f2b76223ea43904120b">GetDescription</a>());</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="comment">// Mount success</span></div>
<div class="line">        {</div>
<div class="line">            isFileSystemMounted = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">char</span> certificateFilePath[<span class="keyword">sizeof</span>(g_CertificateFileDirectory) + <span class="keyword">sizeof</span>(g_CertificateFileName) +</div>
<div class="line">            (<span class="keyword">sizeof</span>(<span class="stringliteral">&quot;host&quot;</span>) &gt; <span class="keyword">sizeof</span>(<span class="stringliteral">&quot;rom&quot;</span>) ? <span class="keyword">sizeof</span>(<span class="stringliteral">&quot;host&quot;</span>) : <span class="keyword">sizeof</span>(<span class="stringliteral">&quot;rom&quot;</span>)) + <span class="keyword">sizeof</span>(<span class="stringliteral">&quot;:/&quot;</span>)];</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Make file path to read from</span></div>
<div class="line">        snprintf(certificateFilePath, <a name="a18"></a><a class="code" href="nn___macro_8h.html#acd3a418aa2fc4a6379eaa722181a46a6">NN_ARRAY_SIZE</a>(certificateFilePath), <span class="stringliteral">&quot;%s:/%s&quot;</span>, pFileSystemPrefix, g_CertificateFileName);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Loading takes a long time for large certificate files</span></div>
<div class="line">        <span class="keywordflow">if</span> (SSL_CTX_load_verify_locations(pCtx, certificateFilePath, <span class="keyword">nullptr</span>) != 1)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;SSL_CTX_load_verify_locations failed to load %s.\n&quot;</span>, certificateFilePath);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            isCertificateLoadSuccessful = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">    } <span class="keywordflow">while</span> (<a name="a19"></a><a class="code" href="nn___macro_8h.html#a71c0f58f6d49fe1392380eed4509ab9a">NN_STATIC_CONDITION</a>(<span class="keyword">false</span>));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (isCertificateLoadSuccessful == <span class="keyword">false</span>)</div>
<div class="line">    {</div>
<div class="line">        SSL_CTX_free(pCtx);</div>
<div class="line">        pCtx = <span class="keyword">nullptr</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (isFileSystemMounted)</div>
<div class="line">    {</div>
<div class="line">        <a name="a20"></a><a class="code" href="namespacenn_1_1fs.html#ac8a95249afd4a87a55d319dfecb0466c">nn::fs::Unmount</a>(pFileSystemPrefix);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (pRomCacheBuffer != <span class="keyword">nullptr</span>)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">delete</span>[] pRomCacheBuffer;</div>
<div class="line">        pRomCacheBuffer = <span class="keyword">nullptr</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> pCtx;</div>
<div class="line">} <span class="comment">// NOLINT(impl/function_size)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">@brief  Destructor will finalize the HttpsClient and also cleans the context if it was not imported</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@details</span></div>
<div class="line"><span class="comment">HttpsClient Destructor</span></div>
<div class="line"><span class="comment">  1. Finalizes the HttpsClient</span></div>
<div class="line"><span class="comment">  2. Frees the OpenSSL context in use when not imported</span></div>
<div class="line"><span class="comment">*  ----------------------------------------------------------------------------------------------*/</span></div>
<div class="line">HttpsClient::~HttpsClient() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    this-&gt;<a class="code" href="namespacenn_1_1htc.html#a8337c461b81d43d85571e7fa4e574c48">Finalize</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// OpenSSL Context Free</span></div>
<div class="line">    <span class="keywordflow">if</span> (!m_IsImportedSslContext &amp;&amp; m_pSslContext != <span class="keyword">nullptr</span>)</div>
<div class="line">    {</div>
<div class="line"><span class="preprocessor">#if defined(FLUSH_SESSION_CACHE)</span></div>
<div class="line">        SSL_CTX_flush_sessions(m_pSslContext, <span class="keyword">static_cast&lt;</span><span class="keywordtype">long</span><span class="keyword">&gt;</span>(time(NULL)));</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">        SSL_CTX_free(m_pSslContext);</div>
<div class="line">    }</div>
<div class="line">    m_pSslContext = <span class="keyword">nullptr</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">@brief  Initializes the HttpsClient so that it may send and receive encrypted OpenSSL</span></div>
<div class="line"><span class="comment">           messages from the provided host</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@param[in] inHostIp  hostname&#39;s IP address</span></div>
<div class="line"><span class="comment">@param[in] portNum  port to use for connection</span></div>
<div class="line"><span class="comment">@param[in] isNonBlocking  connect and handshake are non-blocking</span></div>
<div class="line"><span class="comment">@param[in] pInHostName  hostname used for OpenSSL security check</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@return  Returns Code::Error on error. If it succeeds it will return Code::OperationCompleted.</span></div>
<div class="line"><span class="comment">           It will return Code::Processing for success while non-blocking in which case you must</span></div>
<div class="line"><span class="comment">           call it again.</span></div>
<div class="line"><span class="comment">@details</span></div>
<div class="line"><span class="comment">Initialize HttpsClient</span></div>
<div class="line"><span class="comment">  1. Setup TCP socket</span></div>
<div class="line"><span class="comment">  2. Setup SSL connection context</span></div>
<div class="line"><span class="comment">  3. Perform OpenSSL handshake</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">Note: When non-blocking: If you wait too long between calls the TCP connect and SSL_handshake</span></div>
<div class="line"><span class="comment">can fail. Be sure to call this often so that it can progress the initialization in a timely manner.</span></div>
<div class="line"><span class="comment">*  ----------------------------------------------------------------------------------------------*/</span></div>
<div class="line">HttpsClient::Status HttpsClient::EstablishConnection(<a class="code" href="structnn_1_1socket_1_1_in_addr.html">nn::socket::InAddr</a> inHostIp, uint16_t portNum, <span class="keywordtype">bool</span> isNonBlocking, <span class="keyword">const</span> <span class="keywordtype">char</span>* pInHostName) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">bool</span> isSuccess = <span class="keyword">true</span>;</div>
<div class="line">    <a class="code" href="nn___abort_8h.html#a5c1a90d3a6474658ae0ac5dc5bcb14e4">NN_ABORT_UNLESS</a>(m_pSslContext != <span class="keyword">nullptr</span>, <span class="stringliteral">&quot;Error: HttpsClient&#39;s constructor failed to import/create an OpenSSL context.\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (m_ConnectionStage &gt;= ConnectionStage::ConnectionStage_ConnectionReady)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;HttpsClient::Initialize is already initialized.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> HttpsClient::Status{ Code::Code_Error,{ 0 }}; <span class="comment">// Already initialized.</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Setup HttpsClient&#39;s data</span></div>
<div class="line">    <span class="keywordflow">if</span> (m_ConnectionStage &lt;= ConnectionStage::ConnectionStage_Initialize)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;HttpsClient::Initialize %s:%d %s mode\n&quot;</span>, pInHostName, portNum,</div>
<div class="line">            isNonBlocking ? <span class="stringliteral">&quot;NonBlocking&quot;</span> : <span class="stringliteral">&quot;Blocking&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Copy hostname</span></div>
<div class="line">        <span class="keywordflow">if</span> (pInHostName &amp;&amp; pInHostName[0] != 0)</div>
<div class="line">        {</div>
<div class="line">            uint32_t hostNameLen = <span class="keyword">static_cast&lt;</span>uint32_t<span class="keyword">&gt;</span>(strlen(pInHostName));</div>
<div class="line">            <a class="code" href="nn___abort_8h.html#a5c1a90d3a6474658ae0ac5dc5bcb14e4">NN_ABORT_UNLESS</a>(hostNameLen &lt; HttpsClient::HostNameBufLen, <span class="stringliteral">&quot;hostname is too long.\n&quot;</span>);</div>
<div class="line">            strncpy(m_HostName, pInHostName, hostNameLen + 1);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        m_IsNonBlocking = isNonBlocking;</div>
<div class="line">        m_PortNumber = portNum;</div>
<div class="line">        m_HostIp = inHostIp;</div>
<div class="line">        m_ConnectionStage++;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (m_ConnectionStage &lt;= ConnectionStage::ConnectionStage_TCPSocketFinish)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// SetupTcpSocket has its own stages inside it</span></div>
<div class="line">            <span class="keyword">auto</span> status = SetupTcpSocket();</div>
<div class="line">            <span class="keywordflow">if</span> (status.code != Code::Code_OperationCompleted)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> status;</div>
<div class="line">            }</div>
<div class="line">            m_ConnectionStage++;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (m_ConnectionStage &lt;= ConnectionStage::ConnectionStage_SSLConnectionSetup)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (!SetupSslConnection())</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;SetupSslConnection() failed.\n&quot;</span>);</div>
<div class="line">                isSuccess = <span class="keyword">false</span>;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            m_ConnectionStage++;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (m_ConnectionStage &lt;= ConnectionStage::ConnectionStage_SSLConnectionHandshake)</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">auto</span> status = PerformSslHandshake();</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (status.code == Code::Code_Processing)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> status;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (status.code == Code::Code_Error)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;PerformSslHandshake() failed.\n&quot;</span>);</div>
<div class="line">                isSuccess = <span class="keyword">false</span>;</div>
<div class="line">                <span class="keywordflow">return</span> <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a>{ Code::Code_Error,{ 0 }};</div>
<div class="line">            }</div>
<div class="line">            m_ConnectionStage++;</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">while</span> (<a class="code" href="nn___macro_8h.html#a71c0f58f6d49fe1392380eed4509ab9a">NN_STATIC_CONDITION</a>(<span class="keyword">false</span>));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (isSuccess &amp;&amp; m_ConnectionStage &lt;= ConnectionStage::ConnectionStage_EstablishConnectionFinish)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;HttpsClient::Initialize finished successfully.\n&quot;</span>);</div>
<div class="line">        m_ConnectionStage = ConnectionStage::ConnectionStage_ConnectionReady;</div>
<div class="line">        <span class="keywordflow">return</span> HttpsClient::Status{ Code::Code_OperationCompleted,{ 0 }};</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Error: HttpsClient::Initialize failed.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> HttpsClient::Status{ Code::Code_Error,{ 0 }};</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">@brief  Create and connect blocking and non-blocking TCP socket for HttpsClient&#39;s</span></div>
<div class="line"><span class="comment">        given hostname</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@return  Returns Code::Error on error. If it succeeds it will return Code::OperationCompleted.</span></div>
<div class="line"><span class="comment">        It will return Code::Processing for success while non-blocking in which case you must</span></div>
<div class="line"><span class="comment">        call it again.</span></div>
<div class="line"><span class="comment">@details</span></div>
<div class="line"><span class="comment">Create a TCP socket and establish a connection with the server</span></div>
<div class="line"><span class="comment">  1. Create a TCP socket by nn::socket::Socket()</span></div>
<div class="line"><span class="comment">  2. Set socket blocking/non-blocking mode</span></div>
<div class="line"><span class="comment">  3. Establish TCP connection with the server by using nn::socket::Connect().</span></div>
<div class="line"><span class="comment">  4. Ensure TCP connection is ready with nn::socket::Select()</span></div>
<div class="line"><span class="comment">*  ----------------------------------------------------------------------------------------------*/</span></div>
<div class="line">HttpsClient::Status HttpsClient::SetupTcpSocket() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (m_ConnectionStage &lt;= ConnectionStage::ConnectionStage_TCPSocketCreate)</div>
<div class="line">    {</div>
<div class="line">        m_TcpSocket = <a name="a21"></a><a class="code" href="namespacenn_1_1socket.html#a9afeb564bac1d0c04af2fec1f00c739f">nn::socket::Socket</a>(<a name="a22"></a><a class="code" href="namespacenn_1_1socket.html#a057d985148e23267303e6d00d7ed205daa4d833d8c15a76105639ddd11bcb614e">nn::socket::Family::Af_Inet</a>, <a name="a23"></a><a class="code" href="namespacenn_1_1socket.html#a1db675083dcccec6500d1435c5dfeaeaae703319723c99d2d3a7ba1ad0dc8f572">nn::socket::Type::Sock_Stream</a>, <a name="a24"></a><a class="code" href="namespacenn_1_1socket.html#a46347de69614965469ac8f3c8056468eaf07a075529789e7d91eefbce84c55d90">nn::socket::Protocol::IpProto_Tcp</a>);</div>
<div class="line">        <span class="keywordflow">if</span> (m_TcpSocket &lt; 0)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Failed to create TCP socket: nn::socket::GetLastError: %d.\n&quot;</span>, <a class="code" href="namespacenn_1_1socket.html#a6db6951cb084f74f4c17d655ce798890">nn::socket::GetLastError</a>());</div>
<div class="line">            <span class="keywordflow">return</span> <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a>{ Code::Code_Error,{ 0 }};</div>
<div class="line">        }</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Created a TCP socket.\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (SetSocketNonBlocking(m_IsNonBlocking) == <span class="keyword">false</span>)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Failed to set TCP socket %s flag: nn::socket::GetLastError: %d.\n&quot;</span>,</div>
<div class="line">                (m_IsNonBlocking ? <span class="stringliteral">&quot;non-blocking&quot;</span> : <span class="stringliteral">&quot;blocking&quot;</span>), <a class="code" href="namespacenn_1_1socket.html#a6db6951cb084f74f4c17d655ce798890">nn::socket::GetLastError</a>());</div>
<div class="line">            <span class="keywordflow">return</span> <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a>{ Code::Code_Error,{ 0 } };</div>
<div class="line">        }</div>
<div class="line">        m_ConnectionStage++;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (m_ConnectionStage &lt;= ConnectionStage::ConnectionStage_TCPSocketStartConnect)</div>
<div class="line">    {</div>
<div class="line">        <a name="_a25"></a><a class="code" href="structnn_1_1socket_1_1_sock_addr_in.html">nn::socket::SockAddrIn</a> serverAddr;</div>
<div class="line">        serverAddr.<a name="a26"></a><a class="code" href="structnn_1_1socket_1_1_sock_addr_in.html#a7fe5afa2fe039b8bbf5a23fae30fe755">sin_addr</a>.<a name="a27"></a><a class="code" href="structnn_1_1socket_1_1_in_addr.html#a4bf7f3c8a8061edacb8f884b61c49a2e">S_addr</a> = m_HostIp.S_addr;</div>
<div class="line">        serverAddr.<a name="a28"></a><a class="code" href="structnn_1_1socket_1_1_sock_addr_in.html#ac8e09f776d8331345ee1870f3aed4535">sin_family</a> = <a class="code" href="namespacenn_1_1socket.html#a057d985148e23267303e6d00d7ed205daa4d833d8c15a76105639ddd11bcb614e">nn::socket::Family::Af_Inet</a>;</div>
<div class="line">        serverAddr.<a name="a29"></a><a class="code" href="structnn_1_1socket_1_1_sock_addr_in.html#ae37d378c458d394a0646d7bfcf72bc4d">sin_port</a> = <a name="a30"></a><a class="code" href="namespacenn_1_1socket.html#a1b6e15ce629648357cf10cc8ada6b8d1">nn::socket::InetHtons</a>(m_PortNumber);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Trying to establish a TCP connection.\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">int</span> rval = <a name="a31"></a><a class="code" href="namespacenn_1_1socket.html#a3aded7f0c8c072c7beb68a670d03d36f">nn::socket::Connect</a>(m_TcpSocket,</div>
<div class="line">            <span class="keyword">reinterpret_cast&lt;</span><a name="_a32"></a><a class="code" href="structnn_1_1socket_1_1_sock_addr.html">nn::socket::SockAddr</a>*<span class="keyword">&gt;</span>(&amp;serverAddr),</div>
<div class="line">            <span class="keyword">sizeof</span>(<a class="code" href="structnn_1_1socket_1_1_sock_addr.html">nn::socket::SockAddr</a>));</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (rval &lt; 0) <span class="comment">// Non-blocking states and Errors</span></div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="namespacenn_1_1socket.html#ad1ade4838b158c7aaf9c9a78338e06ae">nn::socket::Errno</a> err = <a class="code" href="namespacenn_1_1socket.html#a6db6951cb084f74f4c17d655ce798890">nn::socket::GetLastError</a>();</div>
<div class="line">            <span class="keywordflow">if</span> (err == <a name="a33"></a><a class="code" href="namespacenn_1_1socket.html#ad1ade4838b158c7aaf9c9a78338e06aea54cafc2ec81f6d1fe8ba661ade3931cb">nn::socket::Errno::EAgain</a>)      <span class="comment">// Waiting on resources</span></div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a>{ Code::Code_Processing,{ 0 } };</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (err == <a name="a34"></a><a class="code" href="namespacenn_1_1socket.html#ad1ade4838b158c7aaf9c9a78338e06aeaa912f0d27a490f37dd216b352c5bafc4">nn::socket::Errno::EInProgress</a>) <span class="comment">// Non-blocking started</span></div>
<div class="line"> </div>
<div class="line">            {</div>
<div class="line">                m_ConnectionStage++;</div>
<div class="line">                <span class="keywordflow">return</span> <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a>{ Code::Code_Processing,{ 0 }};</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (err == <a class="code" href="namespacenn_1_1socket.html#ad1ade4838b158c7aaf9c9a78338e06aead87a63798e8be82fcb6b21bf1389ebb3">nn::socket::Errno::ESuccess</a> || <span class="comment">// Non-blocking completed instantly</span></div>
<div class="line">                err == <a name="a35"></a><a class="code" href="namespacenn_1_1socket.html#ad1ade4838b158c7aaf9c9a78338e06aea01a1169f10a84bd5ca327117f7357ffc">nn::socket::Errno::EAlready</a>)   <span class="comment">// Connection already created</span></div>
<div class="line">            {</div>
<div class="line">                m_ConnectionStage++;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Failed to establish TCP connection: nn::socket::GetLastError: %d.\n&quot;</span>, <a class="code" href="namespacenn_1_1socket.html#a6db6951cb084f74f4c17d655ce798890">nn::socket::GetLastError</a>());</div>
<div class="line">                <span class="keywordflow">return</span> <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a>{ Code::Code_Error,{ 0 }};</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="comment">// Success</span></div>
<div class="line">        {</div>
<div class="line">            m_ConnectionStage++;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Non-blocking check for TCP connect completion</span></div>
<div class="line">    <span class="keywordflow">if</span> (m_ConnectionStage &lt;= ConnectionStage::ConnectionStage_TCPSocketFinishConnect)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Select to check to see the connect has completed.</span></div>
<div class="line">        <span class="comment">// This is one by checking to see if the descriptor is writable.</span></div>
<div class="line">        <a name="_a36"></a><a class="code" href="structnn_1_1socket_1_1_fd_set.html">nn::socket::FdSet</a> writeSet;</div>
<div class="line">        <a name="a37"></a><a class="code" href="namespacenn_1_1socket.html#aa62380fb58406f3d7e83ea25c6deab35">nn::socket::FdSetZero</a>(&amp;writeSet);</div>
<div class="line">        <a name="a38"></a><a class="code" href="namespacenn_1_1socket.html#a1ea80c65c3a931a374bf2f0aab5153d1">nn::socket::FdSetSet</a>(m_TcpSocket, &amp;writeSet);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Timeout of 10 seconds</span></div>
<div class="line">        <a name="_a39"></a><a class="code" href="structnn_1_1socket_1_1_time_val.html">nn::socket::TimeVal</a> timeout = {};</div>
<div class="line">        timeout.<a name="a40"></a><a class="code" href="structnn_1_1socket_1_1_time_val.html#ac07cd524371c2ecc7ab157ceed3fb46c">tv_sec</a> = 10;</div>
<div class="line">        <span class="comment">// Non-blocking connect uses write set</span></div>
<div class="line">        <span class="keywordtype">int</span> result = <a name="a41"></a><a class="code" href="namespacenn_1_1socket.html#aa523b16a6004b8748cc0116f9ed65dd2">nn::socket::Select</a>(m_TcpSocket + 1, <span class="keyword">nullptr</span>, &amp;writeSet, <span class="keyword">nullptr</span>, &amp;timeout);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (result == 0) <span class="comment">// Timeout, connection not ready</span></div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a>{ Code::Code_Processing,{ 0 }};</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (result &lt; 0) <span class="comment">// Error, select failed!</span></div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Failed to establish a TCP connection: 0x%x:%d, nn::socket::GetLastError: %d.\n&quot;</span>,</div>
<div class="line">                m_HostIp.S_addr, <a name="a42"></a><a class="code" href="namespacenn_1_1socket.html#aa8de3f19aaf80d2233a668fc7ebe6f38">nn::socket::InetNtohs</a>(m_PortNumber), <a class="code" href="namespacenn_1_1socket.html#a6db6951cb084f74f4c17d655ce798890">nn::socket::GetLastError</a>());</div>
<div class="line">            PrintSocketError(m_TcpSocket);</div>
<div class="line">            <span class="keywordflow">return</span> <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a>{ Code::Code_Error,{ 0 } };</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Success, connection ready!</span></div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Established a TCP connection.\n&quot;</span>);</div>
<div class="line">        m_ConnectionStage++;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a>{ Code::Code_OperationCompleted,{ 0 }};</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">@brief  Set the TCP socket to blocking/non-blocking mode</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@param[in] isNonBlocking  If true TCP socket becomes non-blocking else if false it becomes blocking.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@details</span></div>
<div class="line"><span class="comment">You may change the socket to non-blocking only once initialize has been completed</span></div>
<div class="line"><span class="comment">and no other thread is currently calling Send(...) or Receive(...).</span></div>
<div class="line"><span class="comment">*  ----------------------------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">bool</span> HttpsClient::SetSocketNonBlocking(<span class="keywordtype">bool</span> isNonBlocking) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <a class="code" href="nn___abort_8h.html#a5c1a90d3a6474658ae0ac5dc5bcb14e4">NN_ABORT_UNLESS</a>(m_TcpSocket &gt;= 0);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> result = <a name="a43"></a><a class="code" href="namespacenn_1_1socket.html#a92cb62635aca20860e3ab848f347ec6f">nn::socket::Fcntl</a>(m_TcpSocket, <a name="a44"></a><a class="code" href="namespacenn_1_1socket.html#ae03bdb6384cac8b1ba7617743144d09fa02772fa35d3b587e7642cbf50c753d08">nn::socket::FcntlCommand::F_GetFl</a>);</div>
<div class="line">    <span class="keywordflow">if</span> (result &lt; 0) <span class="comment">// Error?</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Failed to get TCP socket flags.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="namespacenn_1_1socket.html#aa04c2b32bf6fe54bdbb1a3f5febdc477">nn::socket::FcntlFlag</a> flags = <span class="keyword">static_cast&lt;</span><a class="code" href="namespacenn_1_1socket.html#aa04c2b32bf6fe54bdbb1a3f5febdc477">nn::socket::FcntlFlag</a><span class="keyword">&gt;</span>(result);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (isNonBlocking)</div>
<div class="line">    {</div>
<div class="line">        result = <a class="code" href="namespacenn_1_1socket.html#a92cb62635aca20860e3ab848f347ec6f">nn::socket::Fcntl</a>(m_TcpSocket, <a name="a45"></a><a class="code" href="namespacenn_1_1socket.html#ae03bdb6384cac8b1ba7617743144d09fada2f7613aac1b87c8679a7b8c03ac9ca">nn::socket::FcntlCommand::F_SetFl</a>,</div>
<div class="line">            (flags | <a name="a46"></a><a class="code" href="namespacenn_1_1socket.html#aa04c2b32bf6fe54bdbb1a3f5febdc477a5693df4e99113d8216f084412a7a3849">nn::socket::FcntlFlag::O_NonBlock</a>));</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="comment">// Is blocking</span></div>
<div class="line">    {</div>
<div class="line">        result = <a class="code" href="namespacenn_1_1socket.html#a92cb62635aca20860e3ab848f347ec6f">nn::socket::Fcntl</a>(m_TcpSocket, <a class="code" href="namespacenn_1_1socket.html#ae03bdb6384cac8b1ba7617743144d09fada2f7613aac1b87c8679a7b8c03ac9ca">nn::socket::FcntlCommand::F_SetFl</a>,</div>
<div class="line">            (flags &amp; ~<a class="code" href="namespacenn_1_1socket.html#aa04c2b32bf6fe54bdbb1a3f5febdc477a5693df4e99113d8216f084412a7a3849">nn::socket::FcntlFlag::O_NonBlock</a>));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (result &lt; 0) <span class="comment">// Error?</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Failed to set %s flag on TCP socket.\n&quot;</span>, m_IsNonBlocking ? <span class="stringliteral">&quot;non-blocking&quot;</span> : <span class="stringliteral">&quot;blocking&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    m_IsNonBlocking = isNonBlocking;</div>
<div class="line">    <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Set socket mode: %s.\n&quot;</span>, isNonBlocking ? <span class="stringliteral">&quot;NonBlocking&quot;</span> : <span class="stringliteral">&quot;Blocking&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">@brief  Setup SSL connection through established TCP connection to the host.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@return  Returns false on error and true on success</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@details</span></div>
<div class="line"><span class="comment">Setup SSL connection context.</span></div>
<div class="line"><span class="comment">  1. Create OpenSSL connection by SSL_new(...)</span></div>
<div class="line"><span class="comment">  2. Setup OpenSSL connection: set in client mode by SSL_set_connect_state, set connection mode</span></div>
<div class="line"><span class="comment">  3. Set cipher config by SSL_Set_cipher_list(...)</span></div>
<div class="line"><span class="comment">  4. Set socket descriptor of OpenSSL connection to out established TCP connection by SSL_set_fd(...)</span></div>
<div class="line"><span class="comment">  5. Configure OpenSSL connection to use the server&#39;s hostname.</span></div>
<div class="line"><span class="comment">*  ----------------------------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">bool</span> HttpsClient::SetupSslConnection() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <a class="code" href="nn___abort_8h.html#a5c1a90d3a6474658ae0ac5dc5bcb14e4">NN_ABORT_UNLESS</a>(m_pSslContext != <span class="keyword">nullptr</span>, <span class="stringliteral">&quot;SSL Context was null when we called SetupSslConnection&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Create OpenSSL connection from the given context</span></div>
<div class="line">    m_pSslConnection = SSL_new(m_pSslContext);</div>
<div class="line">    <span class="keywordflow">if</span> (m_pSslConnection == <span class="keyword">nullptr</span>)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Failed to create SSL object.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Put OpenSSL connection into client mode.</span></div>
<div class="line">    SSL_set_connect_state(m_pSslConnection);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Set the OpenSSL&#39;s connection modes</span></div>
<div class="line">    SSL_set_mode(m_pSslConnection,</div>
<div class="line">        SSL_MODE_AUTO_RETRY |           <span class="comment">// In blocking mode, automate retries</span></div>
<div class="line">        SSL_MODE_ENABLE_PARTIAL_WRITE); <span class="comment">// Allow partial writes on SSL_write</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Setup cipher config</span></div>
<div class="line">    <span class="comment">// Whatever cipher config you end up using, it is recommended that you check 1-2</span></div>
<div class="line">    <span class="comment">// times a year to see that the cipher hasn&#39;t been compromised.</span></div>
<div class="line">    <span class="comment">// Resources which may help verify security:</span></div>
<div class="line">    <span class="comment">// https://www.ssllabs.com/ssltest/analyze.html - general scan (port 443 only)</span></div>
<div class="line">    <span class="comment">// https://sslanalyzer.comodoca.com/ - general scan</span></div>
<div class="line">    <span class="comment">// https://cc.dcsec.uni-hannover.de/ - list browser&#39;s cipher suites</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Cipher config string operators</span></div>
<div class="line">    <span class="comment">// &#39;:&#39; &lt;- separator of cipher strings</span></div>
<div class="line">    <span class="comment">// &#39;!&#39; &lt;- permanently deletes the cipher from the list</span></div>
<div class="line">    <span class="comment">// &#39;+&#39; &lt;- moves the cipher suite to the end of the list</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Set Cipher</span></div>
<div class="line">    <span class="comment">//const char* const CipherConfig = &quot;DEFAULT:! DHE:! 3DES:+RSA&quot;; // example</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* <span class="keyword">const</span> CipherConfig = <span class="stringliteral">&quot;DEFAULT&quot;</span>;</div>
<div class="line">    <span class="keywordtype">int</span> result = SSL_set_cipher_list(m_pSslConnection, CipherConfig);</div>
<div class="line">    <span class="keywordflow">if</span> (result != 1)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Failed to set cipher list.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Print all possible ciphers</span></div>
<div class="line"><span class="preprocessor">#ifdef PRINT_POSSIBLE_CIPHER_NAMES</span></div>
<div class="line">    <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Possible cipher suites to select from in OpenSSL connection {\n&quot;</span>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* pCipherSuite = <span class="keyword">nullptr</span>;</div>
<div class="line">    <span class="keywordtype">int</span> suiteIndex = 0;</div>
<div class="line">    <span class="keywordflow">while</span> ((pCipherSuite = SSL_get_cipher_list(m_pSslConnection, suiteIndex++)) != <span class="keyword">nullptr</span>)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;%s\n&quot;</span>, pCipherSuite);</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;} // cipher suites\n&quot;</span>);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Set SSL&#39;s socket fd</span></div>
<div class="line">    result = SSL_set_fd(m_pSslConnection, m_TcpSocket);</div>
<div class="line">    <span class="keywordflow">if</span> (result != 1)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Failed to set ssl&#39;s socket to m_TcpSocket.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Set host name for tls extension</span></div>
<div class="line">    <span class="keywordflow">if</span> (m_HostName[0] != 0)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Server Name Indication is an extension to TLS that many servers will want.</span></div>
<div class="line">        <span class="keywordtype">long</span> res = SSL_set_tlsext_host_name(m_pSslConnection, m_HostName);</div>
<div class="line">        <span class="keywordflow">if</span> (res != 1)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Failed to set OpenSSL connection hostname.\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">@brief  Perform OpenSSL handshake to host on OpenSSL connection.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@return  Returns Code::Error on error OR Code::StreamTerminated if the connection was lost.</span></div>
<div class="line"><span class="comment">        If it succeeds it will return Code::OperationCompleted. It will return Code::Processing</span></div>
<div class="line"><span class="comment">        for success while non-blocking in which case you must call it again.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@details</span></div>
<div class="line"><span class="comment">Perform OpenSSL handshake (blocking/non-blocking)</span></div>
<div class="line"><span class="comment">  1. Start/run SSL handshake by SSL_do_handshake(...)</span></div>
<div class="line"><span class="comment">       if non-blocking call until Code::Processing is no longer returned</span></div>
<div class="line"><span class="comment">  2. Verifies the certificate given by the server.</span></div>
<div class="line"><span class="comment">*  ----------------------------------------------------------------------------------------------*/</span></div>
<div class="line">HttpsClient::Status HttpsClient::PerformSslHandshake() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <a class="code" href="nn___abort_8h.html#a5c1a90d3a6474658ae0ac5dc5bcb14e4">NN_ABORT_UNLESS</a>(m_pSslContext != <span class="keyword">nullptr</span>);</div>
<div class="line">    <a class="code" href="nn___abort_8h.html#a5c1a90d3a6474658ae0ac5dc5bcb14e4">NN_ABORT_UNLESS</a>(m_pSslConnection != <span class="keyword">nullptr</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> result = SSL_do_handshake(m_pSslConnection);</div>
<div class="line">    <span class="keywordflow">if</span> (result != 1) <span class="comment">// Handshake process is incomplete</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">int</span> code = SSL_get_error(m_pSslConnection, result);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (IsBlockingCode(code)) <span class="comment">// Non-blocking notice</span></div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a>{ Code::Code_Processing,{ 0 } };</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsTerminatedCode(code) || IsErrorCode(code)) <span class="comment">// Non-recoverable error occurred</span></div>
<div class="line">        {</div>
<div class="line">            Code statusCode = IsTerminatedCode(code) ? Code::Code_StreamTerminated : Code::Code_Error;</div>
<div class="line">            PrintOpenSslErrors(<span class="stringliteral">&quot;SSL_do_handshake failed in HttpsClient::PerformSslHandshake&quot;</span>, code);</div>
<div class="line">            PrintSocketError(m_TcpSocket);</div>
<div class="line">            <span class="keywordflow">return</span> HttpsClient::Status{ statusCode,{ 0 } };</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;SSL_do_handshake() success.\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (VerifyCertificate())</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;PerformSslHandshake success.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a>{ Code::Code_OperationCompleted,{ 0 } };</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="comment">// Certificate verify failed</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Certificate validation failed.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a>{ Code::Code_Error,{ 0 } };</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">@brief  Verify the received certificate from the host.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@return  returns true if the certificate is valid and false when the verification has failed. If</span></div>
<div class="line"><span class="comment">        g_IsCertificateValidationEnabled is false, always returns true.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@details</span></div>
<div class="line"><span class="comment">Verify Certificate</span></div>
<div class="line"><span class="comment">  1. Check to see that we have gotten a certificate from the server</span></div>
<div class="line"><span class="comment">  2. Verify received certificate by out connection&#39;s context&#39;s certificate data</span></div>
<div class="line"><span class="comment">  3. Verify hostname</span></div>
<div class="line"><span class="comment">  4. Verify the certificate time (before start AND expired)</span></div>
<div class="line"><span class="comment">  5. When build option is enabled, print the server&#39;s certificate</span></div>
<div class="line"><span class="comment">*  ----------------------------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">bool</span> HttpsClient::VerifyCertificate() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (g_IsCertificateValidationEnabled == <span class="keyword">false</span>)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;\n#################################################&quot;</span>);</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;\n### Warning: Skipped certificate verification ###&quot;</span>);</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;\n#################################################\n\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span>  isValidCert = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordtype">long</span>  result = X509_V_OK;</div>
<div class="line">    X509* pCert = SSL_get_peer_certificate(m_pSslConnection);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">        <span class="comment">// Check that we did receive a certificate</span></div>
<div class="line">        <span class="keywordflow">if</span> (pCert == <span class="keyword">nullptr</span>)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;SSL did not receive peer certificate.\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;SSL received peer certificate.\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">        <span class="comment">// Verify certificate against loaded certificate</span></div>
<div class="line">        <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">        <span class="comment">// Verify that the received certificate is valid. Only returns 1 error</span></div>
<div class="line">        <span class="comment">// so we may have multiple issues when X509_V_OK is not returned.</span></div>
<div class="line">        result = SSL_get_verify_result(m_pSslConnection);</div>
<div class="line">        <span class="keywordflow">if</span> (result != X509_V_OK)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Certificate validation failed: result: %d.\n&quot;</span>, result);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">        <span class="comment">// Verify the name</span></div>
<div class="line">        <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">        <span class="keywordtype">char</span>* pPeerName = <span class="keyword">nullptr</span>;</div>
<div class="line">        result = X509_check_host(pCert, m_HostName, strlen(m_HostName), 0, &amp;pPeerName);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (pPeerName != <span class="keyword">nullptr</span>)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;OpenSSL handshake name validation %s: expected: %s, received: %s.\n&quot;</span>,</div>
<div class="line">                (result != -1) ? <span class="stringliteral">&quot;success&quot;</span> : <span class="stringliteral">&quot;fail&quot;</span>,</div>
<div class="line">                m_HostName,</div>
<div class="line">                pPeerName);</div>
<div class="line"> </div>
<div class="line">            OPENSSL_free(pPeerName);</div>
<div class="line">            pPeerName = <span class="keyword">nullptr</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;OpenSSL handshake name validation %s: expected: %s.\n&quot;</span>,</div>
<div class="line">                (result != -1) ? <span class="stringliteral">&quot;success&quot;</span> : <span class="stringliteral">&quot;fail&quot;</span>,</div>
<div class="line">                m_HostName);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">        <span class="comment">// Verify the time</span></div>
<div class="line">        <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">        <span class="keyword">const</span> ASN1_TIME* pNotBeforeTime = <span class="keyword">nullptr</span>;</div>
<div class="line">        <span class="keyword">const</span> ASN1_TIME* pNotAfterTime = <span class="keyword">nullptr</span>;</div>
<div class="line">        <span class="keywordtype">bool</span>             isNotYetValid = <span class="keyword">false</span>;</div>
<div class="line">        <span class="keywordtype">bool</span>             isExpired = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Test not before/before start time?</span></div>
<div class="line">        pNotBeforeTime = X509_get0_notBefore(pCert);</div>
<div class="line">        <span class="keywordflow">if</span> (pNotBeforeTime == <span class="keyword">nullptr</span>)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;OpenSSL handshake certificate failed to get before start time.\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            result = X509_cmp_current_time(pNotBeforeTime);</div>
<div class="line">            <span class="keywordflow">if</span> (result &gt; -1)</div>
<div class="line">            {</div>
<div class="line">                isNotYetValid = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Test not after/expired time</span></div>
<div class="line">        pNotAfterTime = X509_get0_notAfter(pCert);</div>
<div class="line">        <span class="keywordflow">if</span> (pNotAfterTime == <span class="keyword">nullptr</span>)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;OpenSSL handshake certificate failed to get expired time.\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            result = X509_cmp_current_time(pNotAfterTime);</div>
<div class="line">            <span class="keywordflow">if</span> (result &lt; 1)</div>
<div class="line">            {</div>
<div class="line">                isExpired = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;OpenSSL handshake certificate time validation %s: before start: %s, expired: %s.\n&quot;</span>,</div>
<div class="line">            (!isNotYetValid &amp;&amp; !isExpired) ? <span class="stringliteral">&quot;success&quot;</span> : <span class="stringliteral">&quot;fail&quot;</span>,</div>
<div class="line">            (isNotYetValid) ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>,</div>
<div class="line">            (isExpired) ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Print Start/Expire times</span></div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Do not close stderr on BIO_free</span></div>
<div class="line">            BIO* pBio = BIO_new_fp(stderr, BIO_NOCLOSE);</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;\tBegins: &quot;</span>);</div>
<div class="line">            ASN1_TIME_print(pBio, pNotBeforeTime);</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;\n\tExpires: &quot;</span>);</div>
<div class="line">            ASN1_TIME_print(pBio, pNotAfterTime);</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">            BIO_free(pBio);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">        <span class="comment">// Print Server&#39;s Certificate</span></div>
<div class="line">        <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line"><span class="preprocessor">#ifdef PRINT_SERVER_CERT</span></div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Do not close stderr on BIO_free</span></div>
<div class="line">            BIO* pBio = BIO_new_fp(stderr, BIO_NOCLOSE);</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;------- Server&#39;s Certificate -------\n&quot;</span>);</div>
<div class="line">            X509_print(pBio, pCert);</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;------------------------------------\n&quot;</span>);</div>
<div class="line">            BIO_free(pBio);</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">        <span class="keywordflow">if</span> (!isExpired &amp;&amp; !isNotYetValid)</div>
<div class="line">        {</div>
<div class="line">            isValidCert = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">while</span> (<a class="code" href="nn___macro_8h.html#a71c0f58f6d49fe1392380eed4509ab9a">NN_STATIC_CONDITION</a>(<span class="keyword">false</span>));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (pCert != <span class="keyword">nullptr</span>)</div>
<div class="line">    {</div>
<div class="line">        X509_free(pCert);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Certificate is%s valid.\n&quot;</span>, isValidCert ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot; NOT&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> isValidCert;</div>
<div class="line">} <span class="comment">// NOLINT(impl/function_size)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">@brief  Sends a buffer of data to the host through the encrypted OpenSSL connection</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@return  Returns Code::Error on error OR Code::StreamTerminated if the connection</span></div>
<div class="line"><span class="comment">                            was lost. If it succeeds it will return Code::OperationCompleted. It will</span></div>
<div class="line"><span class="comment">                            return Code::Processing for success while non-blocking in which case you</span></div>
<div class="line"><span class="comment">                            must call it again.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@param[in] pSendBuffer  buffer of unencrypted data to send</span></div>
<div class="line"><span class="comment">@param[in] sendBufferSize  buffer size in bytes</span></div>
<div class="line"><span class="comment">@param[in] pEndFunc  callback once the send has been finished (Complete, Terminated, and Error)</span></div>
<div class="line"><span class="comment">@param[in] pEndFuncUserData  callback userData argument</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@details</span></div>
<div class="line"><span class="comment">Sends data through an encrypted OpenSSL connection:</span></div>
<div class="line"><span class="comment">   You must call this function with the same pointer, data, and size multiple times, do not</span></div>
<div class="line"><span class="comment">   change the parameters between calls. (enabling SSL_MODE_ACCEPT_MOVING_WRITE_BUFFER option</span></div>
<div class="line"><span class="comment">   will allow only you to change the pointer value if desired, but not the data) You must call</span></div>
<div class="line"><span class="comment">   this function until it stops returning the processing code for the send to succeed in</span></div>
<div class="line"><span class="comment">   non-blocking mode.</span></div>
<div class="line"><span class="comment">*  ----------------------------------------------------------------------------------------------*/</span></div>
<div class="line">HttpsClient::Status HttpsClient::Send(</div>
<div class="line">    <span class="keywordtype">char</span>* pSendBuffer, <span class="keywordtype">size_t</span> sendBufferSize,</div>
<div class="line">    EndOperationCallback pEndFunc,</div>
<div class="line">    <span class="keywordtype">void</span>* pEndFuncUserData) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <a class="code" href="nn___abort_8h.html#a5c1a90d3a6474658ae0ac5dc5bcb14e4">NN_ABORT_UNLESS</a>(m_ConnectionStage == ConnectionStage::ConnectionStage_ConnectionReady);</div>
<div class="line">    <a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(sendBufferSize &lt;= INT_MAX);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="nn___macro_8h.html#a71c0f58f6d49fe1392380eed4509ab9a">NN_STATIC_CONDITION</a>(<span class="keyword">true</span>))</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// SSL_write serves as a poll and write in a non-blocking mode. If we fail to write because</span></div>
<div class="line">        <span class="comment">// we are non-blocking then we will return back to the calling function with Processing.</span></div>
<div class="line">        <span class="comment">// If we do not send all of the buffer, we cannot change the arguments between partial</span></div>
<div class="line">        <span class="comment">// sends.</span></div>
<div class="line">        <span class="keywordtype">int</span> sentBytes = SSL_write(m_pSslConnection, pSendBuffer, <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(sendBufferSize));</div>
<div class="line">        <span class="keywordflow">if</span> (sentBytes &gt; 0)</div>
<div class="line">        {</div>
<div class="line">            m_BytesSentFromBuffer += sentBytes;</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// Finished sending buffer?</span></div>
<div class="line">            <span class="keywordflow">if</span> (m_BytesSentFromBuffer == <span class="keyword">static_cast&lt;</span>nn::SignedSize<span class="keyword">&gt;</span>(sendBufferSize))</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="comment">// Write process is incomplete</span></div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">int</span> code = SSL_get_error(m_pSslConnection, sentBytes);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (IsBlockingCode(code)) <span class="comment">// Non-blocking notice</span></div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a>{ Code::Code_Processing,{ m_BytesSentFromBuffer } };</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsTerminatedCode(code) || IsErrorCode(code)) <span class="comment">// Nonrecoverable error.</span></div>
<div class="line">            {</div>
<div class="line">                Code statusCode = IsTerminatedCode(code) ? Code::Code_StreamTerminated : Code::Code_Error;</div>
<div class="line">                <span class="keywordflow">if</span> (statusCode == Code::Code_Error)</div>
<div class="line">                {</div>
<div class="line">                    PrintOpenSslErrors(<span class="stringliteral">&quot;SSL_write hit an error in HttpsClient::Send&quot;</span>, code);</div>
<div class="line">                    PrintSocketError(m_TcpSocket);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (pEndFunc != <span class="keyword">nullptr</span>)</div>
<div class="line">                {</div>
<div class="line">                    pEndFunc(<span class="keyword">this</span>, statusCode, pEndFuncUserData);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">return</span> HttpsClient::Status{ statusCode,{ m_BytesSentFromBuffer } };</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> ret = HttpsClient::Status{ Code::Code_OperationCompleted,{ m_BytesSentFromBuffer } };</div>
<div class="line">    m_BytesSentFromBuffer = 0;</div>
<div class="line">    <span class="keywordflow">if</span> (pEndFunc != <span class="keyword">nullptr</span>)</div>
<div class="line">    {</div>
<div class="line">        pEndFunc(<span class="keyword">this</span>, Code::Code_OperationCompleted, pEndFuncUserData);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">@brief  Sends a buffer of data to the host through the encrypted SSL connection.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@return  Returns Code::Error on error OR Code::StreamTerminated if the connection was lost.</span></div>
<div class="line"><span class="comment">                                If it succeeds, it returns Code::OperationCompleted. It returns Code::Processing</span></div>
<div class="line"><span class="comment">                                for success while it is not blocking, in which case you must call it again.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@param[in] pReceiveBuffer  Buffer of unencrypted data to receive.</span></div>
<div class="line"><span class="comment">@param[in] receiveBufferSize  Buffer size, in bytes.</span></div>
<div class="line"><span class="comment">@param[in] pProcessFunc  Callback to process data equal to the value of receiveBuffer. Must return a buffer of the same length.</span></div>
<div class="line"><span class="comment">@param[in] pEndFunc  Callback after the send has been finished (Complete, Terminated, or Error).</span></div>
<div class="line"><span class="comment">@param[in] pProcessFuncUserData  Callback userData argument for processFunc.</span></div>
<div class="line"><span class="comment">@param[in] pEndFuncUserData  Callback userData argument for endFunc.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@details</span></div>
<div class="line"><span class="comment">Decrypt and read incoming data from an OpenSSL connection:</span></div>
<div class="line"><span class="comment">  The given ProcessFunc will be called with a filled received data buffer of receive buffer&#39;s size</span></div>
<div class="line"><span class="comment">  or smaller until there are no more bytes to read, or the connection has been terminated.</span></div>
<div class="line"><span class="comment">*  ----------------------------------------------------------------------------------------------*/</span></div>
<div class="line">HttpsClient::Status HttpsClient::Receive(</div>
<div class="line">    <span class="keywordtype">char</span>* pReceiveBuffer, <span class="keywordtype">size_t</span> receiveBufferSize,</div>
<div class="line">    ProcessReceiveCallback pProcessFunc,</div>
<div class="line">    EndOperationCallback pEndFunc,</div>
<div class="line">    <span class="keywordtype">void</span>* pProcessFuncUserData,</div>
<div class="line">    <span class="keywordtype">void</span>* pEndFuncUserData) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <a class="code" href="nn___abort_8h.html#a5c1a90d3a6474658ae0ac5dc5bcb14e4">NN_ABORT_UNLESS</a>(m_ConnectionStage == ConnectionStage::ConnectionStage_ConnectionReady);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Read 1 buffer OR the whole stream, whichever is smaller per 1 loop.</span></div>
<div class="line">    nn::SignedSize totalBytesProcessed = 0;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">size_t</span> bytesInReceiveBuffer = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="nn___macro_8h.html#a71c0f58f6d49fe1392380eed4509ab9a">NN_STATIC_CONDITION</a>(<span class="keyword">true</span>))</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">size_t</span> byteLeftInBuffer = receiveBufferSize - bytesInReceiveBuffer;</div>
<div class="line">        <a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(byteLeftInBuffer &gt; 0);</div>
<div class="line">        <a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(byteLeftInBuffer &lt;= INT_MAX);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// SSL_read serves as a poll and read in a non-blocking mode. If we fail to write because</span></div>
<div class="line">        <span class="comment">// we are non-blocking then we will return back to the calling function with Processing.</span></div>
<div class="line">        <span class="keywordtype">int</span> bytesRead = SSL_read(m_pSslConnection, pReceiveBuffer + bytesInReceiveBuffer, <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(byteLeftInBuffer));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (bytesRead &gt; 0)  <span class="comment">// Some bytes put into receive buffer</span></div>
<div class="line">        {</div>
<div class="line">            totalBytesProcessed += bytesRead;</div>
<div class="line">            bytesInReceiveBuffer += bytesRead;</div>
<div class="line">            m_ReceivedTotalBytes += bytesRead;</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// Receive buffer can fit more?</span></div>
<div class="line">            <a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(bytesInReceiveBuffer &lt;= receiveBufferSize);</div>
<div class="line">            <span class="keywordflow">if</span> (bytesInReceiveBuffer &lt; <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(receiveBufferSize))</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="comment">// Read process is incomplete</span></div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">int</span> code = SSL_get_error(m_pSslConnection, bytesRead);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (IsBlockingCode(code)) <span class="comment">// Non-blocking notice</span></div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> <a class="code" href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">Status</a>{ Code::Code_Processing,{ totalBytesProcessed } };</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsTerminatedCode(code) || IsErrorCode(code)) <span class="comment">// Non-recoverable error occurred</span></div>
<div class="line">            {</div>
<div class="line">                Code statusCode = IsTerminatedCode(code) ? Code::Code_StreamTerminated : Code::Code_Error;</div>
<div class="line">                <span class="keywordflow">if</span> (statusCode == Code::Code_Error)</div>
<div class="line">                {</div>
<div class="line">                    PrintOpenSslErrors(<span class="stringliteral">&quot;SSL_read hit an error in HttpsClient::Receive&quot;</span>, code);</div>
<div class="line">                    PrintSocketError(m_TcpSocket);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (bytesInReceiveBuffer &gt; 0) <span class="comment">// Still bytes we could process</span></div>
<div class="line">                {</div>
<div class="line">                    pReceiveBuffer = pProcessFunc(pReceiveBuffer, bytesInReceiveBuffer, pProcessFuncUserData);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (pEndFunc != <span class="keyword">nullptr</span>)</div>
<div class="line">                {</div>
<div class="line">                        pEndFunc(<span class="keyword">this</span>, statusCode, pEndFuncUserData);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">return</span> HttpsClient::Status{ statusCode,{ m_ReceivedTotalBytes } };</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// WARNING: This buffer may only contain only part of the entire stream</span></div>
<div class="line">        <span class="comment">// from the HTTPS GET request! If you wish to ensure the entire stream</span></div>
<div class="line">        <span class="comment">// is received you will need to change this logic.</span></div>
<div class="line">        <span class="comment">// WARNING: You MUST return either the passed buffer OR a different buffer</span></div>
<div class="line">        <span class="comment">// of the same length from this function.</span></div>
<div class="line">        pReceiveBuffer = pProcessFunc(pReceiveBuffer, bytesInReceiveBuffer, pProcessFuncUserData);</div>
<div class="line">        bytesInReceiveBuffer = 0;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (bytesRead == 0)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">break</span>; <span class="comment">// Finished</span></div>
<div class="line">        }</div>
<div class="line">        <a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(pReceiveBuffer != <span class="keyword">nullptr</span>, <span class="stringliteral">&quot;ProcessSslReceivedData function must return a valid buffer&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (pEndFunc != <span class="keyword">nullptr</span>)</div>
<div class="line">    {</div>
<div class="line">        pEndFunc(<span class="keyword">this</span>, Code::Code_OperationCompleted, pEndFuncUserData);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> HttpsClient::Status{ Code::Code_OperationCompleted, { m_ReceivedTotalBytes } };</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">@brief  Finalizes the HttpsClient</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@details</span></div>
<div class="line"><span class="comment">Finalize HttpsClient</span></div>
<div class="line"><span class="comment">  1. Destroy OpenSSL connection</span></div>
<div class="line"><span class="comment">  2. Close TCP socket</span></div>
<div class="line"><span class="comment">  3. Reset some internal state to allow for reuse</span></div>
<div class="line"><span class="comment">*  ----------------------------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">void</span> HttpsClient::Finalize() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// OpenSSL Shutdown</span></div>
<div class="line">    <span class="keywordflow">if</span> (m_pSslConnection != <span class="keyword">nullptr</span>)</div>
<div class="line">    {</div>
<div class="line">        SSL_clear(m_pSslConnection);</div>
<div class="line">        SSL_shutdown(m_pSslConnection);</div>
<div class="line">        SSL_free(m_pSslConnection); <span class="comment">// Also frees X509_STORE</span></div>
<div class="line">        m_pSslConnection = <span class="keyword">nullptr</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Close TCP socket</span></div>
<div class="line">    <span class="keywordflow">if</span> (m_TcpSocket &gt;= 0)</div>
<div class="line">    {</div>
<div class="line">        <a name="a47"></a><a class="code" href="namespacenn_1_1socket.html#ae01110d228e2148d830b1ecfb9aaa425">nn::socket::Close</a>(m_TcpSocket);</div>
<div class="line">        m_TcpSocket = -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Reset some of our state</span></div>
<div class="line">    m_IsNonBlocking = <span class="keyword">false</span>;</div>
<div class="line">    m_PortNumber = <span class="keyword">static_cast&lt;</span>uint16_t<span class="keyword">&gt;</span>(-1);</div>
<div class="line">    m_HostIp.S_addr = <span class="keyword">static_cast&lt;</span><a class="code" href="namespacenn_1_1socket.html#ac08c7d39c115b363db7819d38172127d">nn::socket::InAddrT</a><span class="keyword">&gt;</span>(-1);</div>
<div class="line">    m_HostName[0] = 0;</div>
<div class="line">    m_ReceivedTotalBytes = 0;</div>
<div class="line">    m_ConnectionStage = ConnectionStage::ConnectionStage_Start;</div>
<div class="line">    m_BytesSentFromBuffer = 0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;HttpsClient finalized.\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">@brief  Initializes the libraries used by HttpsClient</span></div>
<div class="line"><span class="comment">*  ----------------------------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">bool</span> InitializeLibraries() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">    <span class="comment">// Initialize nn::nifm</span></div>
<div class="line">    <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">    <a class="code" href="classnn_1_1_result.html">nn::Result</a> nnResult = <a name="a48"></a><a class="code" href="namespacenn_1_1nifm.html#a0e3aaf3209696149ec22613e1d3d6705">nn::nifm::Initialize</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (nnResult.<a class="code" href="classnn_1_1_result.html#a5d119d9cb4918fc3cd09215437b91c13">IsFailure</a>())</div>
<div class="line">    {</div>
<div class="line">        PrintNnResult(<span class="stringliteral">&quot;nn::nifm::Initialize failed&quot;</span>, nnResult);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">    g_IsNifmLibInitialized = <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// This is a blocking call. Use nn::nifm::SubmitNetworkRequest() and</span></div>
<div class="line">    <span class="comment">// nn::nifm::IsNetworkAvailable() if you want to do this without blocking</span></div>
<div class="line">    <a name="a49"></a><a class="code" href="namespacenn_1_1nifm.html#ac42c271bffbeb6324e5a41ae779d6575">nn::nifm::SubmitNetworkRequestAndWait</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a50"></a><a class="code" href="namespacenn_1_1nifm.html#a933a28d229a56e800703d95d4830fc6a">nn::nifm::IsNetworkAvailable</a>() == <span class="keyword">false</span>)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Error: nifm failed to make the network available.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">    <span class="comment">// Initialize nn::socket</span></div>
<div class="line">    <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">    nnResult = <a name="a51"></a><a class="code" href="namespacenn_1_1socket.html#adacc3405184e8f28fb630745b9f43db0">nn::socket::Initialize</a>(g_SocketConfigWithMemory);</div>
<div class="line">    <span class="keywordflow">if</span> (nnResult.<a class="code" href="classnn_1_1_result.html#a5d119d9cb4918fc3cd09215437b91c13">IsFailure</a>())</div>
<div class="line">    {</div>
<div class="line">        PrintNnResult(<span class="stringliteral">&quot;nn::socket::Initialize failed&quot;</span>, nnResult);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">    g_IsSocketLibInitialized = <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">    <span class="comment">// Initialize OpenSSL</span></div>
<div class="line">    <span class="comment">// ----------------------------------------------------------------</span></div>
<div class="line">    <span class="keywordtype">int</span> result = OPENSSL_init_ssl(OPENSSL_INIT_NO_ATEXIT, <span class="keyword">nullptr</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (result != 1)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Errors here may be caused by reinitializing OpenSSL after</span></div>
<div class="line">        <span class="comment">// cleanup which is not allowed.</span></div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;SSL_library_init failed.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    result = OpenSSL_add_all_algorithms();</div>
<div class="line">    <span class="keywordflow">if</span> (result != 1)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;OpenSSL_add_all_algorithms failed.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">    g_IsSslLibInitialized = <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Initialize the SSL_library_nnsdk_init</span></div>
<div class="line">    ossl_nnsdk_config config = {};</div>
<div class="line">    <span class="keywordflow">if</span> (g_IsCertFileInHost)</div>
<div class="line">    {</div>
<div class="line">        config.pMountPath = <span class="stringliteral">&quot;host:&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        config.pMountPath = <span class="stringliteral">&quot;rom:&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    config.mountPathLength = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(strlen(config.pMountPath)); <span class="comment">// We know this cast is safe because pMountPath can only either be &quot;host:&quot; or &quot;rom:&quot;</span></div>
<div class="line">    config.useBuiltInCertificates = 0;</div>
<div class="line">    config.pPrivate = <span class="keyword">nullptr</span>;</div>
<div class="line">    result = SSL_library_nnsdk_init(config);</div>
<div class="line">    <span class="keywordflow">if</span> (result != 0)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;SSL_library_nnsdk_init failed: %d.\n&quot;</span>, result);</div>
<div class="line">        <span class="comment">// Try and continue, may already be initialized</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">@brief  Finalize the libraries used by HttpsClient</span></div>
<div class="line"><span class="comment">*  ----------------------------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">void</span> FinalizeLibraries() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (g_IsSslLibInitialized)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Finalizes OpenSSL (libcrypto, libssl)</span></div>
<div class="line">        <span class="comment">// You cannot reinitialize OpenSSL beyond this point!</span></div>
<div class="line">        OPENSSL_cleanup();</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (g_IsSocketLibInitialized)</div>
<div class="line">    {</div>
<div class="line">        <a name="a52"></a><a class="code" href="namespacenn_1_1socket.html#a28a801f086aadf0b731a721567f3e4b2">nn::socket::Finalize</a>();</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (g_IsNifmLibInitialized)</div>
<div class="line">    {</div>
<div class="line">        <a name="a53"></a><a class="code" href="namespacenn_1_1nifm.html#a7704800c5ddaa16c5f0f89f6fa42174b">nn::nifm::CancelNetworkRequest</a>();</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">@brief  Parse the given command line arguments to get the hostname, enable certificate verification,</span></div>
<div class="line"><span class="comment">       and file path for the certificate file from host or rom.</span></div>
<div class="line"><span class="comment">*  ----------------------------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">void</span> ParseCommandLine() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> HostNameArgIndex = 1;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> VerifyEnabledArgIndex = 2;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> CertificatePathArgIndex = 3;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span>        argc = <a name="a54"></a><a class="code" href="namespacenn_1_1os.html#acf2fa6b7b7074a51d0b2de1664cc7bb5">nn::os::GetHostArgc</a>();</div>
<div class="line">    <span class="keywordtype">char</span>**     argv = <a name="a55"></a><a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Get hostname</span></div>
<div class="line">    <span class="keywordflow">if</span> (argc &gt;= HostNameArgIndex + 1)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (strlen(argv[HostNameArgIndex]) &gt; <span class="keyword">sizeof</span>(g_HostName) - 1)</div>
<div class="line">        {</div>
<div class="line">            <a name="a56"></a><a class="code" href="nn___abort_8h.html#a205eaac89c47d49cb982bf136e113de2">NN_ABORT</a>(<span class="stringliteral">&quot;Invalid command line argument passed: Host URL is too long&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Using %s URL to reach host.\n&quot;</span>, argv[HostNameArgIndex]);</div>
<div class="line">        strncpy(g_HostName, argv[HostNameArgIndex], <span class="keyword">sizeof</span>(g_HostName) - 1);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="comment">// Default to example.com</span></div>
<div class="line">    {</div>
<div class="line">        strncpy(g_HostName, <span class="stringliteral">&quot;example.com&quot;</span>, <span class="keyword">sizeof</span>(g_HostName) - 1);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Get enable certificate validation.</span></div>
<div class="line">    <span class="keywordflow">if</span> (argc &gt;= VerifyEnabledArgIndex + 1)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(argv[VerifyEnabledArgIndex], <span class="stringliteral">&quot;true&quot;</span>) == 0 ||</div>
<div class="line">            strcmp(argv[VerifyEnabledArgIndex], <span class="stringliteral">&quot;TRUE&quot;</span>) == 0)</div>
<div class="line">        {</div>
<div class="line">            g_IsCertificateValidationEnabled = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strcmp(argv[VerifyEnabledArgIndex], <span class="stringliteral">&quot;false&quot;</span>) == 0 ||</div>
<div class="line">                strcmp(argv[VerifyEnabledArgIndex], <span class="stringliteral">&quot;FALSE&quot;</span>) == 0)</div>
<div class="line">        {</div>
<div class="line">            g_IsCertificateValidationEnabled = <span class="keyword">false</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___abort_8h.html#a205eaac89c47d49cb982bf136e113de2">NN_ABORT</a>(<span class="stringliteral">&quot;Invalid command line argument passed: The verify certificate argument is neither true or false.&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Get certificate file from ROM or host.</span></div>
<div class="line">    <span class="keywordflow">if</span> (argc &gt;= CertificatePathArgIndex + 1)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">char</span>* pFilePath = <span class="keyword">nullptr</span>;</div>
<div class="line">        <span class="comment">// File in rom?</span></div>
<div class="line">        <span class="keywordflow">if</span> ((pFilePath = strstr(argv[CertificatePathArgIndex], <span class="stringliteral">&quot;rom:&quot;</span>)) == argv[CertificatePathArgIndex])</div>
<div class="line">        {</div>
<div class="line">            g_IsCertFileInRom = <span class="keyword">true</span>;</div>
<div class="line">            pFilePath += strlen(<span class="stringliteral">&quot;rom:&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">// File in host?</span></div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pFilePath = strstr(argv[CertificatePathArgIndex], <span class="stringliteral">&quot;host:&quot;</span>)) == argv[CertificatePathArgIndex])</div>
<div class="line">        {</div>
<div class="line">            g_IsCertFileInHost = <span class="keyword">true</span>;</div>
<div class="line">            pFilePath += strlen(<span class="stringliteral">&quot;host:&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="comment">// Invalid command line argument</span></div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___abort_8h.html#a205eaac89c47d49cb982bf136e113de2">NN_ABORT</a>(<span class="stringliteral">&quot;Invalid command line argument passed: Certificate file path should have \&quot;rom:\&quot; OR \&quot;host:\&quot; prefix &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;before the data region&#39;s file path to indicate if it is located on rom or the host machine.&quot;</span>);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Find the directory and file name segments of the command line argument.</span></div>
<div class="line">        <span class="keywordtype">char</span>* pFileName = pFilePath;</div>
<div class="line">        <span class="keywordtype">char</span>* pTmp = <span class="keyword">nullptr</span>;</div>
<div class="line">        <span class="keywordflow">while</span> ((pTmp = strstr(pFileName, <span class="stringliteral">&quot;/&quot;</span>)) != 0)</div>
<div class="line">        {</div>
<div class="line">            pFileName = pTmp + 1;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Directory path too long?</span></div>
<div class="line">        <span class="keywordflow">if</span> ((pFileName - pFilePath) &gt; <span class="keyword">sizeof</span>(g_CertificateFileDirectory) - 1)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___abort_8h.html#a205eaac89c47d49cb982bf136e113de2">NN_ABORT</a>(<span class="stringliteral">&quot;Invalid command line argument passed: Certificate directory is too long.&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">// File name too long?</span></div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strlen(pFileName) &gt; <span class="keyword">sizeof</span>(g_CertificateFileName) - 1)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___abort_8h.html#a205eaac89c47d49cb982bf136e113de2">NN_ABORT</a>(<span class="stringliteral">&quot;Invalid command line argument passed: Certificate file name is too long.&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="comment">// Set directory and file name.</span></div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Using %s as a path to the CA Certificate file loaded from %s.\n&quot;</span>,</div>
<div class="line">                pFilePath, g_IsCertFileInHost ? <span class="stringliteral">&quot;host&quot;</span> : <span class="stringliteral">&quot;rom&quot;</span>);</div>
<div class="line"> </div>
<div class="line">            strncpy(g_CertificateFileDirectory, pFilePath, pFileName - pFilePath);</div>
<div class="line">            strncpy(g_CertificateFileName, pFileName, <span class="keyword">sizeof</span>(g_CertificateFileName) - 1);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">@brief  Runs an HTTPS GET command on a specified host.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@return  Returns true on success and false when an error has occurred.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@param[in] pHostName  Hostname of server</span></div>
<div class="line"><span class="comment">@param[in] tcpPortNumber  IP port number to use</span></div>
<div class="line"><span class="comment">@param[in] isNonBlocking  Is connection non-blocking</span></div>
<div class="line"><span class="comment">@param[in] pImportContext  OpenSSL context to use. Can be nullptr but will take longer to load.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@details</span></div>
<div class="line"><span class="comment">Sends an HTTP GET command and receives the data into a process buffer</span></div>
<div class="line"><span class="comment">  1. Resolve given hostname to its official name and IP</span></div>
<div class="line"><span class="comment">  2. Create HttpsClient and initialize</span></div>
<div class="line"><span class="comment">  3. Send HTTP GET command to host</span></div>
<div class="line"><span class="comment">  4. Receive data from host</span></div>
<div class="line"><span class="comment">  5. Cleanup HttpsClient</span></div>
<div class="line"><span class="comment">*  ----------------------------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">bool</span> RunHttpsClient(<span class="keyword">const</span> <span class="keywordtype">char</span>* pHostName, uint16_t tcpPortNumber, <span class="keywordtype">bool</span> isNonBlocking, SSL_CTX* pImportContext) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Resolve Hostname</span></div>
<div class="line">    <span class="keywordflow">if</span> (pHostName != <span class="keyword">nullptr</span> &amp;&amp; pHostName[0] == <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Host name was not given.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ------------------------------------------------------------------------------------------------</span></div>
<div class="line">    <span class="comment">// DNS resolve hostname to IP</span></div>
<div class="line">    <span class="comment">// ------------------------------------------------------------------------------------------------</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Note: This is a blocking call to get the IP address info of the given hostName. pHostEnt is</span></div>
<div class="line">    <span class="comment">// pointing to thread local storage so if GetHostEntByName is called again pHostEnt&#39;s data may change.</span></div>
<div class="line">    <span class="comment">// Be sure to use a deep copy like below.</span></div>
<div class="line">    <a name="_a57"></a><a class="code" href="structnn_1_1socket_1_1_host_ent.html">nn::socket::HostEnt</a>* pHostEnt = <a name="a58"></a><a class="code" href="namespacenn_1_1socket.html#a358030926e9e63c2e322de2bd3d26719">nn::socket::GetHostEntByName</a>(pHostName);</div>
<div class="line">    <span class="keywordflow">if</span> (pHostEnt == <span class="keyword">nullptr</span>)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Failed to resolve host name %s nn::socket::GetLastError: %d.\n&quot;</span>, pHostName, <a class="code" href="namespacenn_1_1socket.html#a6db6951cb084f74f4c17d655ce798890">nn::socket::GetLastError</a>());</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Note: We just pick the first one. If you know specifics about who you are connecting to you may be</span></div>
<div class="line">    <span class="comment">// able to make this more secure to prevent DNS spoofing.</span></div>
<div class="line">    <a class="code" href="structnn_1_1socket_1_1_in_addr.html">nn::socket::InAddr</a> inetAddr = {};</div>
<div class="line">    <a class="code" href="nn___abort_8h.html#a5c1a90d3a6474658ae0ac5dc5bcb14e4">NN_ABORT_UNLESS</a>(pHostEnt-&gt;<a name="a59"></a><a class="code" href="structnn_1_1socket_1_1_host_ent.html#af0d2c52d1061c0356eba7eb6dae35f27">h_length</a> == <span class="keyword">sizeof</span>(inetAddr), <span class="stringliteral">&quot;Invalid IP detected, NOT supported.&quot;</span>);</div>
<div class="line">    memcpy(&amp;inetAddr, pHostEnt-&gt;<a name="a60"></a><a class="code" href="structnn_1_1socket_1_1_host_ent.html#a1d26bb1a8b570fc8e1aa0a498ed5934d">h_addr_list</a>[0], pHostEnt-&gt;<a class="code" href="structnn_1_1socket_1_1_host_ent.html#af0d2c52d1061c0356eba7eb6dae35f27">h_length</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ------------------------------------------------------------------------------------------------</span></div>
<div class="line">    <span class="comment">// Run HttpsClient</span></div>
<div class="line">    <span class="comment">// ------------------------------------------------------------------------------------------------</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Callbacks</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> OnEndSend = [](HttpsClient* pHttpsClient, HttpsClient::Code endCode, <span class="keywordtype">void</span>* pUserData)</div>
<div class="line">    {</div>
<div class="line">        <a name="a61"></a><a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(pHttpsClient);</div>
<div class="line">        <a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(endCode);</div>
<div class="line">        <a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(pUserData);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Finished sending https request.\n&quot;</span>);</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Process while receiving: Add your processing logic here. Be aware that the data buffer</span></div>
<div class="line">    <span class="comment">// of size len may only contain part of the whole stream depending on size of the receiveBuffer</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> ProcessStream = [](<span class="keywordtype">char</span>* pData, <span class="keywordtype">size_t</span> len, <span class="keywordtype">void</span>* pUserData) -&gt; <span class="keywordtype">char</span>*</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(len);</div>
<div class="line">        <a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(pUserData);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(g_ProcessBufferIndex + len &lt; <span class="keyword">sizeof</span>(g_ProcessBuffer));</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Copy data to process buffer.</span></div>
<div class="line">        memcpy(g_ProcessBuffer + g_ProcessBufferIndex, pData, len);</div>
<div class="line">        g_ProcessBufferIndex += len;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Note: If you don&#39;t want to copy to a separate process buffer,</span></div>
<div class="line">        <span class="comment">// you may use the data buffer as long as you return a pointer</span></div>
<div class="line">        <span class="comment">// to a new buffer of equal size (i.e., receiveBufferSize, not len).</span></div>
<div class="line">        <span class="keywordflow">return</span> pData;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> OnEndReceive = [](HttpsClient* pHttpsClient, HttpsClient::Code endCode, <span class="keywordtype">void</span>* pUserData)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(pHttpsClient);</div>
<div class="line">        <a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(pUserData);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Check end code to see if we properly ended</span></div>
<div class="line">        <span class="keywordflow">if</span> (endCode == HttpsClient::Code_Error)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;ERROR: OpenSSL connection shutdown unexpectedly!\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (endCode == HttpsClient::Code::Code_StreamTerminated)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Connection closed by the host.\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (endCode != HttpsClient::Code_Error)</div>
<div class="line">        {</div>
<div class="line">            PrintProcessBuffer();</div>
<div class="line">        }</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> canContinue = <span class="keyword">true</span>;</div>
<div class="line">    HttpsClient* pHttpsClient = <span class="keyword">new</span>(std::nothrow) HttpsClient(pImportContext);</div>
<div class="line">    <a name="a62"></a><a class="code" href="nn___abort_8h.html#ae872300a22548da2b586ef68d2c048a3">NN_ABORT_UNLESS_NOT_NULL</a>(pHttpsClient);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Make receive buffer for httpsClient</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> ReceiveBufferSize = 2048;</div>
<div class="line">    <span class="keywordtype">char</span>* pReceiveBuffer = <span class="keyword">new</span>(std::nothrow) <span class="keywordtype">char</span>[ReceiveBufferSize];</div>
<div class="line">    <a class="code" href="nn___abort_8h.html#ae872300a22548da2b586ef68d2c048a3">NN_ABORT_UNLESS_NOT_NULL</a>(pReceiveBuffer);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Setup HTTPS GET command so it is ready to send once we are connected.</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> HttpsReqBuffSize = 512;</div>
<div class="line">    <span class="keywordtype">char</span> httpReqBuff[HttpsReqBuffSize] = { 0 };</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Note: Not every website will supports GET HTTP/1.1 so it may be</span></div>
<div class="line">    <span class="comment">// useful to use GET HTTP/1.0 to maximize support for more websites.</span></div>
<div class="line">    <span class="keywordtype">size_t</span> httpReqBuffLen = snprintf(httpReqBuff, <a class="code" href="nn___macro_8h.html#acd3a418aa2fc4a6379eaa722181a46a6">NN_ARRAY_SIZE</a>(httpReqBuff),</div>
<div class="line">        <span class="stringliteral">&quot;GET / HTTP/1.0\r\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;Host: %s\r\n\r\n&quot;</span>,</div>
<div class="line">        pHostName) + 1;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Initialize the HttpsClient which includes the following steps</span></div>
<div class="line">    <span class="comment">// 1) Connect to host via TCP</span></div>
<div class="line">    <span class="comment">// 2) Perform OpenSSL handshake and verification</span></div>
<div class="line">    <span class="keywordflow">while</span> (canContinue)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">auto</span> status = pHttpsClient-&gt;EstablishConnection(inetAddr, tcpPortNumber, isNonBlocking, pHostName);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Call is non-blocking, call again</span></div>
<div class="line">        <span class="keywordflow">if</span> (status.code == HttpsClient::Code::Code_Processing)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Do other work, call again in a few milliseconds</span></div>
<div class="line">            <a name="a63"></a><a class="code" href="namespacenn_1_1os.html#a96b335e87af44c60a0d6dca75f11c9d2">nn::os::SleepThread</a>(<a name="a64"></a><a class="code" href="classnn_1_1_time_span.html#a2441d3c84cc24b901342ce11f87cd39c">nn::TimeSpan::FromMilliSeconds</a>(SleepDurationMs));</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Error?</span></div>
<div class="line">        <span class="keywordflow">if</span> (status.code == HttpsClient::Code::Code_Error)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Note: To Try again we could call Finalize and continue</span></div>
<div class="line">            canContinue = <span class="keyword">false</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Finished?</span></div>
<div class="line">        <span class="keywordflow">if</span> (status.code == HttpsClient::Code::Code_OperationCompleted)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (canContinue)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Sending http GET request:\n%s\n&quot;</span>, httpReqBuff);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Sends a buffer to the host. In this case a HTTP GET command</span></div>
<div class="line">    <span class="comment">// which will send us back the host&#39;s website through OpenSSL</span></div>
<div class="line">    <span class="keywordflow">while</span> (canContinue)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">auto</span> status = pHttpsClient-&gt;Send(httpReqBuff, httpReqBuffLen, OnEndSend, <span class="keyword">nullptr</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Call is non-blocking, call again</span></div>
<div class="line">        <span class="keywordflow">if</span> (status.code == HttpsClient::Code::Code_Processing)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Do other work, call again in a few milliseconds</span></div>
<div class="line">            <a class="code" href="namespacenn_1_1os.html#a96b335e87af44c60a0d6dca75f11c9d2">nn::os::SleepThread</a>(<a class="code" href="classnn_1_1_time_span.html#a2441d3c84cc24b901342ce11f87cd39c">nn::TimeSpan::FromMilliSeconds</a>(SleepDurationMs));</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Error?</span></div>
<div class="line">        <span class="keywordflow">if</span> (status.code == HttpsClient::Code::Code_Error)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;httpsClient-&gt;Send() failed.\n&quot;</span>);</div>
<div class="line">            canContinue = <span class="keyword">false</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Finished?</span></div>
<div class="line">        <span class="keywordflow">if</span> (status.code == HttpsClient::Code::Code_OperationCompleted)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;Sent a total of %d bytes.\n&quot;</span>, status.bytesSent);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Closed by otherside?</span></div>
<div class="line">        <span class="keywordflow">if</span> (status.code == HttpsClient::Code::Code_StreamTerminated)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;In httpsClient-&gt;Send() TCP stream terminated!&quot;</span>);</div>
<div class="line">            canContinue = <span class="keyword">false</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Await and receive the HTTP GET command&#39;s data from the website</span></div>
<div class="line">    <span class="keywordflow">while</span> (canContinue)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">auto</span> status = pHttpsClient-&gt;Receive(pReceiveBuffer, ReceiveBufferSize, ProcessStream, OnEndReceive, <span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Call is non-blocking, call again</span></div>
<div class="line">        <span class="keywordflow">if</span> (status.code == HttpsClient::Code::Code_Processing)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Do other work, call again in a few milliseconds</span></div>
<div class="line">            <a class="code" href="namespacenn_1_1os.html#a96b335e87af44c60a0d6dca75f11c9d2">nn::os::SleepThread</a>(<a class="code" href="classnn_1_1_time_span.html#a2441d3c84cc24b901342ce11f87cd39c">nn::TimeSpan::FromMilliSeconds</a>(SleepDurationMs));</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Error?</span></div>
<div class="line">        <span class="keywordflow">if</span> (status.code == HttpsClient::Code::Code_Error)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;httpsClient-&gt;Receive() failed\n&quot;</span>);</div>
<div class="line">            canContinue = <span class="keyword">false</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Finished?</span></div>
<div class="line">        <span class="keywordflow">if</span> (status.code == HttpsClient::Code::Code_OperationCompleted ||</div>
<div class="line">            status.code == HttpsClient::Code::Code_StreamTerminated)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(status.totalBytesReceived &gt;= 0 &amp;&amp; <span class="keyword">static_cast&lt;</span><span class="keywordtype">size_t</span><span class="keyword">&gt;</span>(status.totalBytesReceived) == g_ProcessBufferIndex);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Free receiveBuffer after use</span></div>
<div class="line">    <span class="keyword">delete</span>[] pReceiveBuffer;</div>
<div class="line">    pReceiveBuffer = <span class="keyword">nullptr</span>;</div>
<div class="line">    <span class="comment">// Cleanup HttpsClient</span></div>
<div class="line">    <span class="keyword">delete</span> pHttpsClient;</div>
<div class="line">    pHttpsClient = <span class="keyword">nullptr</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Reset Index for global process buffer between runs</span></div>
<div class="line">    g_ProcessBufferIndex = 0;</div>
<div class="line">    <span class="keywordflow">return</span> canContinue;</div>
<div class="line">} <span class="comment">// NOLINT(impl/function_size)</span></div>
<div class="line"> </div>
<div class="line">} <span class="comment">// Namespace.</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">@brief  Sample program that runs the HttpsClient</span></div>
<div class="line"><span class="comment">*  ----------------------------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">void</span> nnMain() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Parse command line for hostname, enable verify certificate, and certificate path (host/rom)</span></div>
<div class="line">    <span class="comment">// Example command line arguments:</span></div>
<div class="line">    <span class="comment">// * example.com true host:E:/openssl/CaCertBundle.pem</span></div>
<div class="line">    <span class="comment">// * example.com true rom:CaCertBundle.pem</span></div>
<div class="line">    ParseCommandLine();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Initialize the require libraries</span></div>
<div class="line">    <span class="keywordflow">if</span> (InitializeLibraries())</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// 443 is the https port used for secure connections over TLS/SSL</span></div>
<div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> uint16_t TcpPortNumber = 443;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Context initialization means loading and parsing the certificate file(s) which</span></div>
<div class="line">        <span class="comment">// takes a significant amount of time. It may be optimal to instead use a single</span></div>
<div class="line">        <span class="comment">// context multiple times.</span></div>
<div class="line">        SSL_CTX* pImportedContext = HttpsClient::CreateSslContext();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (pImportedContext == <span class="keyword">nullptr</span>)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;CreateSslContext failed to create a context\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Run https GET request</span></div>
<div class="line">            <span class="keywordflow">if</span> (RunHttpsClient(g_HostName, TcpPortNumber, <span class="keyword">true</span>, pImportedContext) == <span class="keyword">false</span>)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a>(<span class="stringliteral">&quot;\n\nHttpsClient failed!\n\n&quot;</span>);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// flush session cache</span></div>
<div class="line"><span class="preprocessor">#if defined(FLUSH_SESSION_CACHE)</span></div>
<div class="line">            SSL_CTX_flush_sessions(pImportedContext, <span class="keyword">static_cast&lt;</span><span class="keywordtype">long</span><span class="keyword">&gt;</span>(time(NULL)));</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">            <span class="comment">// Clean up SSL context after use</span></div>
<div class="line">            SSL_CTX_free(pImportedContext);</div>
<div class="line">            pImportedContext = <span class="keyword">nullptr</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    FinalizeLibraries();</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="ttc" id="aclassnn_1_1_result_html"><div class="ttname"><a href="classnn_1_1_result.html">nn::Result</a></div><div class="ttdoc">Represents the generic result of an operation.</div><div class="ttdef"><b>Definition:</b> nn_Result.h:32</div></div>
<div class="ttc" id="aclassnn_1_1_result_html_a5d119d9cb4918fc3cd09215437b91c13"><div class="ttname"><a href="classnn_1_1_result.html#a5d119d9cb4918fc3cd09215437b91c13">nn::Result::IsFailure</a></div><div class="ttdeci">bool IsFailure() const NN_NOEXCEPT</div><div class="ttdoc">! Returns IsSuccess().</div><div class="ttdef"><b>Definition:</b> nn_Result.h:99</div></div>
<div class="ttc" id="aclassnn_1_1_result_html_a77240fc1cc27829bc388d34c97357693"><div class="ttname"><a href="classnn_1_1_result.html#a77240fc1cc27829bc388d34c97357693">nn::Result::GetModule</a></div><div class="ttdeci">int GetModule() const NN_NOEXCEPT</div><div class="ttdoc">Gets the module value.</div><div class="ttdef"><b>Definition:</b> nn_Result.h:111</div></div>
<div class="ttc" id="aclassnn_1_1_result_html_a800c5bb9b58c3f2b76223ea43904120b"><div class="ttname"><a href="classnn_1_1_result.html#a800c5bb9b58c3f2b76223ea43904120b">nn::Result::GetDescription</a></div><div class="ttdeci">int GetDescription() const NN_NOEXCEPT</div><div class="ttdoc">Gets the description value.</div><div class="ttdef"><b>Definition:</b> nn_Result.h:123</div></div>
<div class="ttc" id="aclassnn_1_1_time_span_html_a2441d3c84cc24b901342ce11f87cd39c"><div class="ttname"><a href="classnn_1_1_time_span.html#a2441d3c84cc24b901342ce11f87cd39c">nn::TimeSpan::FromMilliSeconds</a></div><div class="ttdeci">static constexpr TimeSpan FromMilliSeconds(int64_t milliSeconds) NN_NOEXCEPT</div><div class="ttdoc">Generates a TimeSpan object from a milliseconds value.</div><div class="ttdef"><b>Definition:</b> nn_TimeSpan.h:550</div></div>
<div class="ttc" id="aclassnn_1_1socket_1_1_config_default_with_memory_html"><div class="ttname"><a href="classnn_1_1socket_1_1_config_default_with_memory.html">nn::socket::ConfigDefaultWithMemory</a></div><div class="ttdoc">Class specifying a default configuration.</div><div class="ttdef"><b>Definition:</b> socket_Config.h:627</div></div>
<div class="ttc" id="afs_8h_html"><div class="ttname"><a href="fs_8h.html">fs.h</a></div><div class="ttdoc">Declarations of API resources for the file system.</div></div>
<div class="ttc" id="anamespacemovie_html_aae52268c80d5ad84f5ca8eda8eaad4c5"><div class="ttname"><a href="namespacemovie.html#aae52268c80d5ad84f5ca8eda8eaad4c5">movie::Status</a></div><div class="ttdeci">Status</div><div class="ttdoc">Enumeration of various status and error codes used throughout the movie library.</div><div class="ttdef"><b>Definition:</b> Status.h:34</div></div>
<div class="ttc" id="anamespacenn_1_1fs_html_a1b85bf3f3cf038cb67a991a3e3304751"><div class="ttname"><a href="namespacenn_1_1fs.html#a1b85bf3f3cf038cb67a991a3e3304751">nn::fs::MountHost</a></div><div class="ttdeci">Result MountHost(const char *name, const char *rootPath) NN_NOEXCEPT</div><div class="ttdoc">Mounts the specified directory in the file system of the host PC and makes it available for operation...</div></div>
<div class="ttc" id="anamespacenn_1_1fs_html_a2e453fe1fbf8f818dc45bbd2897105cd"><div class="ttname"><a href="namespacenn_1_1fs.html#a2e453fe1fbf8f818dc45bbd2897105cd">nn::fs::MountRom</a></div><div class="ttdeci">Result MountRom(const char *name, void *pFileSystemCacheBuffer, size_t fileSystemCacheBufferSize) NN_NOEXCEPT</div><div class="ttdoc">Mounts ROM resource data.</div></div>
<div class="ttc" id="anamespacenn_1_1fs_html_a5df6e3385c795a5bd046790ef7f17f2d"><div class="ttname"><a href="namespacenn_1_1fs.html#a5df6e3385c795a5bd046790ef7f17f2d">nn::fs::QueryMountRomCacheSize</a></div><div class="ttdeci">Result QueryMountRomCacheSize(size_t *pOutValue) NN_NOEXCEPT</div><div class="ttdoc">Get the size needed for the nn::fs::MountRom file system cache.</div></div>
<div class="ttc" id="anamespacenn_1_1fs_html_ac8a95249afd4a87a55d319dfecb0466c"><div class="ttname"><a href="namespacenn_1_1fs.html#ac8a95249afd4a87a55d319dfecb0466c">nn::fs::Unmount</a></div><div class="ttdeci">void Unmount(const char *name) NN_NOEXCEPT</div><div class="ttdoc">Unmounts a mounted file system and frees the resources.</div></div>
<div class="ttc" id="anamespacenn_1_1htc_html_a8337c461b81d43d85571e7fa4e574c48"><div class="ttname"><a href="namespacenn_1_1htc.html#a8337c461b81d43d85571e7fa4e574c48">nn::htc::Finalize</a></div><div class="ttdeci">void Finalize() NN_NOEXCEPT</div><div class="ttdoc">Finalizes the htc library.</div></div>
<div class="ttc" id="anamespacenn_1_1nifm_html_a0e3aaf3209696149ec22613e1d3d6705"><div class="ttname"><a href="namespacenn_1_1nifm.html#a0e3aaf3209696149ec22613e1d3d6705">nn::nifm::Initialize</a></div><div class="ttdeci">nn::Result Initialize() NN_NOEXCEPT</div><div class="ttdoc">Initializes the network connection management library and makes its functionality available.</div></div>
<div class="ttc" id="anamespacenn_1_1nifm_html_a7704800c5ddaa16c5f0f89f6fa42174b"><div class="ttname"><a href="namespacenn_1_1nifm.html#a7704800c5ddaa16c5f0f89f6fa42174b">nn::nifm::CancelNetworkRequest</a></div><div class="ttdeci">void CancelNetworkRequest() NN_NOEXCEPT</div><div class="ttdoc">Withdraws a network connection request.</div></div>
<div class="ttc" id="anamespacenn_1_1nifm_html_a933a28d229a56e800703d95d4830fc6a"><div class="ttname"><a href="namespacenn_1_1nifm.html#a933a28d229a56e800703d95d4830fc6a">nn::nifm::IsNetworkAvailable</a></div><div class="ttdeci">bool IsNetworkAvailable() NN_NOEXCEPT</div><div class="ttdoc">Determines whether a network connection is available.</div></div>
<div class="ttc" id="anamespacenn_1_1nifm_html_ac42c271bffbeb6324e5a41ae779d6575"><div class="ttname"><a href="namespacenn_1_1nifm.html#ac42c271bffbeb6324e5a41ae779d6575">nn::nifm::SubmitNetworkRequestAndWait</a></div><div class="ttdeci">void SubmitNetworkRequestAndWait() NN_NOEXCEPT</div><div class="ttdoc">Makes a request to the system for a network connection, and blocks until the request is accepted or d...</div></div>
<div class="ttc" id="anamespacenn_1_1os_html_a96b335e87af44c60a0d6dca75f11c9d2"><div class="ttname"><a href="namespacenn_1_1os.html#a96b335e87af44c60a0d6dca75f11c9d2">nn::os::SleepThread</a></div><div class="ttdeci">void SleepThread(TimeSpan time) NN_NOEXCEPT</div><div class="ttdoc">Puts the current thread to sleep for the specified amount of time.</div></div>
<div class="ttc" id="anamespacenn_1_1os_html_abd77e6bf19be140867869cc759fa492c"><div class="ttname"><a href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a></div><div class="ttdeci">char ** GetHostArgv() NN_NOEXCEPT</div><div class="ttdoc">Gets the array of pointers (argc) to the strings for the host-specified command-line arguments.</div></div>
<div class="ttc" id="anamespacenn_1_1os_html_acf2fa6b7b7074a51d0b2de1664cc7bb5"><div class="ttname"><a href="namespacenn_1_1os.html#acf2fa6b7b7074a51d0b2de1664cc7bb5">nn::os::GetHostArgc</a></div><div class="ttdeci">int GetHostArgc() NN_NOEXCEPT</div><div class="ttdoc">Gets the number of host-specified command-line arguments (argc).</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_a057d985148e23267303e6d00d7ed205daa4d833d8c15a76105639ddd11bcb614e"><div class="ttname"><a href="namespacenn_1_1socket.html#a057d985148e23267303e6d00d7ed205daa4d833d8c15a76105639ddd11bcb614e">nn::socket::Family::Af_Inet</a></div><div class="ttdeci">@ Af_Inet</div><div class="ttdoc">Internet Version 4.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_a0da164bafc83a64e6a51068805e5df52"><div class="ttname"><a href="namespacenn_1_1socket.html#a0da164bafc83a64e6a51068805e5df52">nn::socket::SockLenT</a></div><div class="ttdeci">unsigned int SockLenT</div><div class="ttdoc">Used for length and size values for socket-related parameters.</div><div class="ttdef"><b>Definition:</b> socket_Types.h:35</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_a1b6e15ce629648357cf10cc8ada6b8d1"><div class="ttname"><a href="namespacenn_1_1socket.html#a1b6e15ce629648357cf10cc8ada6b8d1">nn::socket::InetHtons</a></div><div class="ttdeci">uint16_t InetHtons(uint16_t hostValue) NN_NOEXCEPT</div><div class="ttdoc">Convert 16-bit integer from host to network byte order.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_a1db675083dcccec6500d1435c5dfeaeaae703319723c99d2d3a7ba1ad0dc8f572"><div class="ttname"><a href="namespacenn_1_1socket.html#a1db675083dcccec6500d1435c5dfeaeaae703319723c99d2d3a7ba1ad0dc8f572">nn::socket::Type::Sock_Stream</a></div><div class="ttdeci">@ Sock_Stream</div><div class="ttdoc">Stream socket.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_a1ea80c65c3a931a374bf2f0aab5153d1"><div class="ttname"><a href="namespacenn_1_1socket.html#a1ea80c65c3a931a374bf2f0aab5153d1">nn::socket::FdSetSet</a></div><div class="ttdeci">long FdSetSet(int fd, FdSet *pFdset) NN_NOEXCEPT</div><div class="ttdoc">Includes a particular descriptor fd in fdset.</div><div class="ttdef"><b>Definition:</b> socket_Api.h:1425</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_a27f36d8472582558c3cb4a31464f50a0"><div class="ttname"><a href="namespacenn_1_1socket.html#a27f36d8472582558c3cb4a31464f50a0">nn::socket::Send</a></div><div class="ttdeci">nn::SignedSize Send(int socket, const void *buffer, size_t bufferLength, MsgFlag flags) NN_NOEXCEPT</div><div class="ttdoc">Send a message from a socket.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_a28a801f086aadf0b731a721567f3e4b2"><div class="ttname"><a href="namespacenn_1_1socket.html#a28a801f086aadf0b731a721567f3e4b2">nn::socket::Finalize</a></div><div class="ttdeci">Result Finalize() NN_NOEXCEPT</div><div class="ttdoc">Finalize socket library.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_a358030926e9e63c2e322de2bd3d26719"><div class="ttname"><a href="namespacenn_1_1socket.html#a358030926e9e63c2e322de2bd3d26719">nn::socket::GetHostEntByName</a></div><div class="ttdeci">HostEnt * GetHostEntByName(const char *pName) NN_NOEXCEPT</div><div class="ttdoc">Look up Family::Af_Inet host IP address by hostname.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_a3aded7f0c8c072c7beb68a670d03d36f"><div class="ttname"><a href="namespacenn_1_1socket.html#a3aded7f0c8c072c7beb68a670d03d36f">nn::socket::Connect</a></div><div class="ttdeci">int Connect(int socket, const SockAddr *pAddress, SockLenT addressLength) NN_NOEXCEPT</div><div class="ttdoc">Initiate a connection on a socket.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_a46347de69614965469ac8f3c8056468eaf07a075529789e7d91eefbce84c55d90"><div class="ttname"><a href="namespacenn_1_1socket.html#a46347de69614965469ac8f3c8056468eaf07a075529789e7d91eefbce84c55d90">nn::socket::Protocol::IpProto_Tcp</a></div><div class="ttdeci">@ IpProto_Tcp</div><div class="ttdoc">Transmission control protocol.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_a4aff7a563a6c808b236246a182996761"><div class="ttname"><a href="namespacenn_1_1socket.html#a4aff7a563a6c808b236246a182996761">nn::socket::GetSockOpt</a></div><div class="ttdeci">int GetSockOpt(int socket, Level level, Option optionName, void *pOutOptionValue, SockLenT *pOutOptionLength) NN_NOEXCEPT</div><div class="ttdoc">Get socket options.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_a6db6951cb084f74f4c17d655ce798890"><div class="ttname"><a href="namespacenn_1_1socket.html#a6db6951cb084f74f4c17d655ce798890">nn::socket::GetLastError</a></div><div class="ttdeci">Errno GetLastError() NN_NOEXCEPT</div><div class="ttdoc">Read the global variable errno.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_a8f9b7859b60d1ee546e472a7e2a9beaaa4418133767fb2aecc740f56abdda0a07"><div class="ttname"><a href="namespacenn_1_1socket.html#a8f9b7859b60d1ee546e472a7e2a9beaaa4418133767fb2aecc740f56abdda0a07">nn::socket::Level::Sol_Socket</a></div><div class="ttdeci">@ Sol_Socket</div><div class="ttdoc">Socket level.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_a92cb62635aca20860e3ab848f347ec6f"><div class="ttname"><a href="namespacenn_1_1socket.html#a92cb62635aca20860e3ab848f347ec6f">nn::socket::Fcntl</a></div><div class="ttdeci">int Fcntl(int socket, FcntlCommand command,...) NN_NOEXCEPT</div><div class="ttdoc">File control.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_a9706518d71ec37371e9aa3ae9a2fa92caa09b2054c97d538ca128022bdb5d70ff"><div class="ttname"><a href="namespacenn_1_1socket.html#a9706518d71ec37371e9aa3ae9a2fa92caa09b2054c97d538ca128022bdb5d70ff">nn::socket::Option::So_Error</a></div><div class="ttdeci">@ So_Error</div><div class="ttdoc">Get error status and clear.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_a9afeb564bac1d0c04af2fec1f00c739f"><div class="ttname"><a href="namespacenn_1_1socket.html#a9afeb564bac1d0c04af2fec1f00c739f">nn::socket::Socket</a></div><div class="ttdeci">int Socket(Family domain, Type type, Protocol protocol) NN_NOEXCEPT</div><div class="ttdoc">Create endpoint for communication.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_aa04c2b32bf6fe54bdbb1a3f5febdc477"><div class="ttname"><a href="namespacenn_1_1socket.html#aa04c2b32bf6fe54bdbb1a3f5febdc477">nn::socket::FcntlFlag</a></div><div class="ttdeci">FcntlFlag</div><div class="ttdoc">Commands used for nn::socket::Fcntl().</div><div class="ttdef"><b>Definition:</b> socket_Types.h:327</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_aa04c2b32bf6fe54bdbb1a3f5febdc477a5693df4e99113d8216f084412a7a3849"><div class="ttname"><a href="namespacenn_1_1socket.html#aa04c2b32bf6fe54bdbb1a3f5febdc477a5693df4e99113d8216f084412a7a3849">nn::socket::FcntlFlag::O_NonBlock</a></div><div class="ttdeci">@ O_NonBlock</div><div class="ttdoc">Non-blocking mode.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_aa523b16a6004b8748cc0116f9ed65dd2"><div class="ttname"><a href="namespacenn_1_1socket.html#aa523b16a6004b8748cc0116f9ed65dd2">nn::socket::Select</a></div><div class="ttdeci">int Select(int numberOfDescriptors, FdSet *pReadDescriptors, FdSet *pWriteDescriptors, FdSet *pExceptDescriptors, TimeVal *pTimeout) NN_NOEXCEPT</div><div class="ttdoc">Synchronous I/O multiplexing.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_aa62380fb58406f3d7e83ea25c6deab35"><div class="ttname"><a href="namespacenn_1_1socket.html#aa62380fb58406f3d7e83ea25c6deab35">nn::socket::FdSetZero</a></div><div class="ttdeci">void FdSetZero(FdSet *pFdset) NN_NOEXCEPT</div><div class="ttdoc">Initializes a descriptor set s to the null set.</div><div class="ttdef"><b>Definition:</b> socket_Api.h:1399</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_aa8de3f19aaf80d2233a668fc7ebe6f38"><div class="ttname"><a href="namespacenn_1_1socket.html#aa8de3f19aaf80d2233a668fc7ebe6f38">nn::socket::InetNtohs</a></div><div class="ttdeci">uint16_t InetNtohs(uint16_t networkValue) NN_NOEXCEPT</div><div class="ttdoc">Convert 16-bit ineger from network to host byte order.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_ac08c7d39c115b363db7819d38172127d"><div class="ttname"><a href="namespacenn_1_1socket.html#ac08c7d39c115b363db7819d38172127d">nn::socket::InAddrT</a></div><div class="ttdeci">uint32_t InAddrT</div><div class="ttdoc">IP address.</div><div class="ttdef"><b>Definition:</b> socket_Types.h:34</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_ad1ade4838b158c7aaf9c9a78338e06ae"><div class="ttname"><a href="namespacenn_1_1socket.html#ad1ade4838b158c7aaf9c9a78338e06ae">nn::socket::Errno</a></div><div class="ttdeci">Errno</div><div class="ttdoc">Global variable errno values, also returned by nn::socket::GetLastError().</div><div class="ttdef"><b>Definition:</b> socket_Errno.h:22</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_ad1ade4838b158c7aaf9c9a78338e06aea01a1169f10a84bd5ca327117f7357ffc"><div class="ttname"><a href="namespacenn_1_1socket.html#ad1ade4838b158c7aaf9c9a78338e06aea01a1169f10a84bd5ca327117f7357ffc">nn::socket::Errno::EAlready</a></div><div class="ttdeci">@ EAlready</div><div class="ttdoc">114</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_ad1ade4838b158c7aaf9c9a78338e06aea54cafc2ec81f6d1fe8ba661ade3931cb"><div class="ttname"><a href="namespacenn_1_1socket.html#ad1ade4838b158c7aaf9c9a78338e06aea54cafc2ec81f6d1fe8ba661ade3931cb">nn::socket::Errno::EAgain</a></div><div class="ttdeci">@ EAgain</div><div class="ttdoc">11</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_ad1ade4838b158c7aaf9c9a78338e06aeaa912f0d27a490f37dd216b352c5bafc4"><div class="ttname"><a href="namespacenn_1_1socket.html#ad1ade4838b158c7aaf9c9a78338e06aeaa912f0d27a490f37dd216b352c5bafc4">nn::socket::Errno::EInProgress</a></div><div class="ttdeci">@ EInProgress</div><div class="ttdoc">115</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_ad1ade4838b158c7aaf9c9a78338e06aead87a63798e8be82fcb6b21bf1389ebb3"><div class="ttname"><a href="namespacenn_1_1socket.html#ad1ade4838b158c7aaf9c9a78338e06aead87a63798e8be82fcb6b21bf1389ebb3">nn::socket::Errno::ESuccess</a></div><div class="ttdeci">@ ESuccess</div><div class="ttdoc">0</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_adacc3405184e8f28fb630745b9f43db0"><div class="ttname"><a href="namespacenn_1_1socket.html#adacc3405184e8f28fb630745b9f43db0">nn::socket::Initialize</a></div><div class="ttdeci">Result Initialize(const Config &amp;config) NN_NOEXCEPT</div><div class="ttdoc">Initialize socket library.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_ae01110d228e2148d830b1ecfb9aaa425"><div class="ttname"><a href="namespacenn_1_1socket.html#ae01110d228e2148d830b1ecfb9aaa425">nn::socket::Close</a></div><div class="ttdeci">int Close(int socket) NN_NOEXCEPT</div><div class="ttdoc">Delete a descriptor.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_ae03bdb6384cac8b1ba7617743144d09fa02772fa35d3b587e7642cbf50c753d08"><div class="ttname"><a href="namespacenn_1_1socket.html#ae03bdb6384cac8b1ba7617743144d09fa02772fa35d3b587e7642cbf50c753d08">nn::socket::FcntlCommand::F_GetFl</a></div><div class="ttdeci">@ F_GetFl</div><div class="ttdoc">Get descriptor status flags.</div></div>
<div class="ttc" id="anamespacenn_1_1socket_html_ae03bdb6384cac8b1ba7617743144d09fada2f7613aac1b87c8679a7b8c03ac9ca"><div class="ttname"><a href="namespacenn_1_1socket.html#ae03bdb6384cac8b1ba7617743144d09fada2f7613aac1b87c8679a7b8c03ac9ca">nn::socket::FcntlCommand::F_SetFl</a></div><div class="ttdeci">@ F_SetFl</div><div class="ttdoc">Set descriptor status flags.</div></div>
<div class="ttc" id="ann___abort_8h_html_a205eaac89c47d49cb982bf136e113de2"><div class="ttname"><a href="nn___abort_8h.html#a205eaac89c47d49cb982bf136e113de2">NN_ABORT</a></div><div class="ttdeci">#define NN_ABORT(...)</div><div class="ttdoc">Stops execution.</div><div class="ttdef"><b>Definition:</b> nn_Abort.h:29</div></div>
<div class="ttc" id="ann___abort_8h_html_a5c1a90d3a6474658ae0ac5dc5bcb14e4"><div class="ttname"><a href="nn___abort_8h.html#a5c1a90d3a6474658ae0ac5dc5bcb14e4">NN_ABORT_UNLESS</a></div><div class="ttdeci">#define NN_ABORT_UNLESS(condition,...)</div><div class="ttdoc">Tests whether a condition has been satisfied and stops execution if it has not.</div><div class="ttdef"><b>Definition:</b> nn_Abort.h:38</div></div>
<div class="ttc" id="ann___abort_8h_html_ae872300a22548da2b586ef68d2c048a3"><div class="ttname"><a href="nn___abort_8h.html#ae872300a22548da2b586ef68d2c048a3">NN_ABORT_UNLESS_NOT_NULL</a></div><div class="ttdeci">#define NN_ABORT_UNLESS_NOT_NULL(pointer)</div><div class="ttdoc">Tests whether the pointer is a null pointer and stops execution if it is.</div><div class="ttdef"><b>Definition:</b> nn_Abort.h:56</div></div>
<div class="ttc" id="ann___assert_8h_html"><div class="ttname"><a href="nn___assert_8h.html">nn_Assert.h</a></div><div class="ttdoc">Declarations for API resources to test whether conditions are satisfied.</div></div>
<div class="ttc" id="ann___assert_8h_html_ade59d1d911907a16c0241f8fe3b31542"><div class="ttname"><a href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a></div><div class="ttdeci">#define NN_ASSERT(condition,...)</div><div class="ttdoc">Tests whether a condition is satisfied.</div><div class="ttdef"><b>Definition:</b> nn_Assert.h:124</div></div>
<div class="ttc" id="ann___log_8h_html"><div class="ttname"><a href="nn___log_8h.html">nn_Log.h</a></div><div class="ttdoc">Declarations for the logging API.</div></div>
<div class="ttc" id="ann___log_8h_html_a2d720c8bc6b733bce63879350d134a84"><div class="ttname"><a href="nn___log_8h.html#a2d720c8bc6b733bce63879350d134a84">NN_LOG</a></div><div class="ttdeci">#define NN_LOG(...)</div><div class="ttdoc">Adds the string specified in the parameter as a log entry.</div><div class="ttdef"><b>Definition:</b> nn_Log.h:33</div></div>
<div class="ttc" id="ann___macro_8h_html_a0e31cc4dc24d85253a31e48b1a85ab33"><div class="ttname"><a href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div><div class="ttdeci">#define NN_NOEXCEPT</div><div class="ttdoc">Declares that the function does not throw exceptions.</div><div class="ttdef"><b>Definition:</b> nn_Macro.h:196</div></div>
<div class="ttc" id="ann___macro_8h_html_a71c0f58f6d49fe1392380eed4509ab9a"><div class="ttname"><a href="nn___macro_8h.html#a71c0f58f6d49fe1392380eed4509ab9a">NN_STATIC_CONDITION</a></div><div class="ttdeci">#define NN_STATIC_CONDITION(condition)</div><div class="ttdoc">Suppresses compiler warnings on intentional, explicitly specified conditional constants.</div><div class="ttdef"><b>Definition:</b> nn_Macro.h:626</div></div>
<div class="ttc" id="ann___macro_8h_html_acd3a418aa2fc4a6379eaa722181a46a6"><div class="ttname"><a href="nn___macro_8h.html#acd3a418aa2fc4a6379eaa722181a46a6">NN_ARRAY_SIZE</a></div><div class="ttdeci">#define NN_ARRAY_SIZE(array)</div><div class="ttdoc">Gets the array size.</div><div class="ttdef"><b>Definition:</b> nn_Macro.h:696</div></div>
<div class="ttc" id="ann___macro_8h_html_af2d1673769927c5eae977d8dde3ce106"><div class="ttname"><a href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a></div><div class="ttdeci">#define NN_UNUSED(variable)</div><div class="ttdoc">Suppresses compiler warnings on intentionally unused variables.</div><div class="ttdef"><b>Definition:</b> nn_Macro.h:610</div></div>
<div class="ttc" id="asocket_8h_html"><div class="ttname"><a href="socket_8h.html">socket.h</a></div><div class="ttdoc">Top level header defining the socket library API.</div></div>
<div class="ttc" id="astructnn_1_1socket_1_1_fd_set_html"><div class="ttname"><a href="structnn_1_1socket_1_1_fd_set.html">nn::socket::FdSet</a></div><div class="ttdoc">Structure used for Select().</div><div class="ttdef"><b>Definition:</b> socket_Types.h:552</div></div>
<div class="ttc" id="astructnn_1_1socket_1_1_host_ent_html"><div class="ttname"><a href="structnn_1_1socket_1_1_host_ent.html">nn::socket::HostEnt</a></div><div class="ttdoc">Structures returned by network data base library.</div><div class="ttdef"><b>Definition:</b> socket_Types.h:510</div></div>
<div class="ttc" id="astructnn_1_1socket_1_1_host_ent_html_a1d26bb1a8b570fc8e1aa0a498ed5934d"><div class="ttname"><a href="structnn_1_1socket_1_1_host_ent.html#a1d26bb1a8b570fc8e1aa0a498ed5934d">nn::socket::HostEnt::h_addr_list</a></div><div class="ttdeci">char ** h_addr_list</div><div class="ttdoc">A NULL-terminated array of network addresses for the host.</div><div class="ttdef"><b>Definition:</b> socket_Types.h:515</div></div>
<div class="ttc" id="astructnn_1_1socket_1_1_host_ent_html_af0d2c52d1061c0356eba7eb6dae35f27"><div class="ttname"><a href="structnn_1_1socket_1_1_host_ent.html#af0d2c52d1061c0356eba7eb6dae35f27">nn::socket::HostEnt::h_length</a></div><div class="ttdeci">int h_length</div><div class="ttdoc">The length, in bytes, of the address.</div><div class="ttdef"><b>Definition:</b> socket_Types.h:514</div></div>
<div class="ttc" id="astructnn_1_1socket_1_1_in_addr_html"><div class="ttname"><a href="structnn_1_1socket_1_1_in_addr.html">nn::socket::InAddr</a></div><div class="ttdoc">Structure for storing Internet address in network format.</div><div class="ttdef"><b>Definition:</b> socket_Types.h:358</div></div>
<div class="ttc" id="astructnn_1_1socket_1_1_in_addr_html_a4bf7f3c8a8061edacb8f884b61c49a2e"><div class="ttname"><a href="structnn_1_1socket_1_1_in_addr.html#a4bf7f3c8a8061edacb8f884b61c49a2e">nn::socket::InAddr::S_addr</a></div><div class="ttdeci">InAddrT S_addr</div><div class="ttdoc">Internet address in network format.</div><div class="ttdef"><b>Definition:</b> socket_Types.h:359</div></div>
<div class="ttc" id="astructnn_1_1socket_1_1_sock_addr_html"><div class="ttname"><a href="structnn_1_1socket_1_1_sock_addr.html">nn::socket::SockAddr</a></div><div class="ttdoc">Structure used to store most addresses.</div><div class="ttdef"><b>Definition:</b> socket_Types.h:366</div></div>
<div class="ttc" id="astructnn_1_1socket_1_1_sock_addr_in_html"><div class="ttname"><a href="structnn_1_1socket_1_1_sock_addr_in.html">nn::socket::SockAddrIn</a></div><div class="ttdoc">Structure used to specify a local or remote endpoint address to which to connect a socket.</div><div class="ttdef"><b>Definition:</b> socket_Types.h:377</div></div>
<div class="ttc" id="astructnn_1_1socket_1_1_sock_addr_in_html_a7fe5afa2fe039b8bbf5a23fae30fe755"><div class="ttname"><a href="structnn_1_1socket_1_1_sock_addr_in.html#a7fe5afa2fe039b8bbf5a23fae30fe755">nn::socket::SockAddrIn::sin_addr</a></div><div class="ttdeci">InAddr sin_addr</div><div class="ttdoc">IP address.</div><div class="ttdef"><b>Definition:</b> socket_Types.h:381</div></div>
<div class="ttc" id="astructnn_1_1socket_1_1_sock_addr_in_html_ac8e09f776d8331345ee1870f3aed4535"><div class="ttname"><a href="structnn_1_1socket_1_1_sock_addr_in.html#ac8e09f776d8331345ee1870f3aed4535">nn::socket::SockAddrIn::sin_family</a></div><div class="ttdeci">Family sin_family</div><div class="ttdoc">Socket address family.</div><div class="ttdef"><b>Definition:</b> socket_Types.h:379</div></div>
<div class="ttc" id="astructnn_1_1socket_1_1_sock_addr_in_html_ae37d378c458d394a0646d7bfcf72bc4d"><div class="ttname"><a href="structnn_1_1socket_1_1_sock_addr_in.html#ae37d378c458d394a0646d7bfcf72bc4d">nn::socket::SockAddrIn::sin_port</a></div><div class="ttdeci">InPortT sin_port</div><div class="ttdoc">IP port.</div><div class="ttdef"><b>Definition:</b> socket_Types.h:380</div></div>
<div class="ttc" id="astructnn_1_1socket_1_1_time_val_html"><div class="ttname"><a href="structnn_1_1socket_1_1_time_val.html">nn::socket::TimeVal</a></div><div class="ttdoc">Structure used by nn::socket::Select() and for setting timeout options with nn::socket::SetSockOpt().</div><div class="ttdef"><b>Definition:</b> socket_Types.h:525</div></div>
<div class="ttc" id="astructnn_1_1socket_1_1_time_val_html_ac07cd524371c2ecc7ab157ceed3fb46c"><div class="ttname"><a href="structnn_1_1socket_1_1_time_val.html#ac07cd524371c2ecc7ab157ceed3fb46c">nn::socket::TimeVal::tv_sec</a></div><div class="ttdeci">long tv_sec</div><div class="ttdoc">Seconds.</div><div class="ttdef"><b>Definition:</b> socket_Types.h:526</div></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
</body>
</html>
